<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="http://cmsj.net/theme/css/style.less">
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->


  <link rel="icon" type="image/vnd.microsoft.icon" href="http://cmsj.net/">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto+Mono">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/fontawesome-all.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/hatena-bookmark-icon.css">

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chris Jones">
  <meta name="description" content="Posts and writings by Chris Jones">
  <meta name="og:site_name" content="cmsj.net">

  <!-- Twitter Card -->


  <meta name="og:url" content="http://cmsj.net/2010/06/08/lawnmower-man.html" />
  <meta name="og:title" content="The Lawnmower Man" />
  <meta name="og:description" content="Introduction This website shares a server with various other network services that form the foundation of my online life (i.e. IRC and Email) and I've been running into capacity issues in the last few months, so I'm running an experiment whereby I upgrade to brand new hardware (Quad Core …" />
  <meta name="keywords" content="">


  <link href="http://cmsj.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cmsj.net Atom" />


  <title>
    cmsj.net
&ndash; The Lawnmower Man  </title></head>

<body>
  <main>
    <header>
      <div class="site-name">
        <a href="http://cmsj.net">cmsj.net</a>
      </div>
      <p>
        <a href="http://cmsj.net/archives.html"><i class="fas fa-archive"></i> Archive</a>
      </p>
    </header>

<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/06/08/lawnmower-man.html">The Lawnmower Man</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Tue 08 June 2010</p>
    </p>
  </div>
  <div class="article__text">
    <h1>Introduction</h1>
<p>This website shares a server with various other network services that form the foundation of my online life (i.e. IRC and Email) and I've been running into capacity issues in the last few months, so I'm running an experiment whereby I upgrade to brand new hardware (Quad Core i7, 8GB of RAM) and partition the available resources across virtual machines so the various network services are isolated into logical security zones.</p>
<h1>Whining</h1>
<p>I have plenty of experience using Xen for this sort of thing, but that's becoming more and more irrelevant in newer kernels/distributions. As much as I think that's a shame and a stupid upstream decision, I can't change it, so I need to move on to KVM and libvirt.</p>
<h1>Resolution</h1>
<p>So, with the beefy new server booted up in a -server kernel and a big, empty LVM Volume Group I got to work creating some virtual machines. This post is mainly a reminder to myself of the things I need to do for each VM :)</p>
<h1>Action</h1>
<p>These are the steps I used to make a VM with 1GB of RAM, 10GB / and 1GB of swap:</p>
<h3>Create an LVM Logical Volume</h3>
<div class="highlight"><pre><span></span><code><span class="err">lvcreate -L11G -n somehostname VolumeGroup</span>
</code></pre></div>

<h3>Create a VM image and libvirt XML definition</h3>
<div class="highlight"><pre><span></span><code><span class="err">ubuntu-vm-builder kvm lucid --arch amd64 --mem=1024 --cpus=1 \</span>
<span class="err">--raw=/dev/VolumeGroup/somehostname --rootsize=10240 --swapsize=1024 \</span>
<span class="err">--kernel-flavour=server --hostname=somehostname \</span>
<span class="err">--mirror=http://archive.ubuntu.com/ubuntu/ --components=main,universe \</span>
<span class="err">--name &#39;Chris Jones&#39; --user cmsj --pass &#39;ubuntu&#39; --bridge virbr0 \</span>
<span class="err">--libvirt qemu:///system --addpkg vim --addpkg ssh --addpkg ubuntu-minimal</span>
</code></pre></div>

<p>Catchy command, huh? ;)</p>
<h3>Wait</h3>
<p>(building the VM will take a few minutes)</p>
<h3>Modify the libvirt XML definition for performance</h3>
<p>The best driver for disk/networking is the paravirtualised "virtio" driver. I found that ubuntu-vm-builder had already configured the networking to use this, but not the disk, so I modified the disk section to look like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;block&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">&#39;/dev/VolumeGroup/somehostname&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vda&#39;</span> <span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
</code></pre></div>

<h3>Modify the libvirt XML definition for emulated serial console</h3>
<p>I don't really want to use VNC to talk to the console of my VMs, so I add the following to the &lt;devices&gt; section of the XML definition to make a virtualised serial port and consider it a console:</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;serial</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/serial&gt;</span>
    <span class="nt">&lt;console</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/console&gt;</span>
</code></pre></div>

<h3>Modify the libvirt XML definition for a better CPU</h3>
<p>I'm running this on an Intel Core i7 (Nehalem), but libvirt's newest defined CPU type is a Core2Duo, so we'll go with that in the root of the &lt;domain&gt; section:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;cpu</span> <span class="na">match=</span><span class="s">&#39;minimum&#39;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;model&gt;</span>core2duo<span class="nt">&lt;/model&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div>

<h3>Import the XML definition into the running libvirt daemon</h3>
<div class="highlight"><pre><span></span><code><span class="err">virsh define /etc/libvirt/qemu/somehostname.xml</span>
</code></pre></div>

<h3>Mount the VM's root filesystem</h3>
<p>The Logical Volume we created should be considered as a whole disk, not a mountable partition, but dmsetup can present the partitions within it, and these should still be present after running ubuntu-vm-builder:</p>
<div class="highlight"><pre><span></span><code><span class="err">mkdir /mnt/tmpvmroot</span>
<span class="err">mount /dev/mapper/VolumeGroup-somehostnamep1 /mnt/tmpvmroot</span>
</code></pre></div>

<h3>Fix fstab in the VM</h3>
<p>Edit /mnt/tmpvmroot/etc/fstab and s/hda/vda/</p>
<h3>Configure serial console in the VM</h3>
<p>Edit ﻿/etc/init/ttyS0.conf and place the following in it:</p>
<div class="highlight"><pre><span></span><code><span class="err">    # ttyS0 - getty</span>
<span class="err">    #</span>
<span class="err">    # This service maintains a getty on ttyS0 from the point the system is</span>
<span class="err">    # started until it is shut down again.</span>
<span class="err">    start on stopped rc RUNLEVEL=[2345]</span>
<span class="err">    stop on runlevel [!2345]</span>
<span class="err">    respawn</span>
<span class="err">    exec /sbin/getty -L 115200 ttyS0 xterm</span>
</code></pre></div>

<p>Edit /boot/grub/menu.lst and look for the commented "defoptions" line. Change it to:</p>
<div class="highlight"><pre><span></span><code><span class="err">    # defoptions=console=ttyS0 console=tty0</span>
</code></pre></div>

<p>(the default "quiet splash" is not useful for servers IMHO)</p>
<h3>Unmount the VM's root filesystem</h3>
<div class="highlight"><pre><span></span><code><span class="err">umount /mnt/tmpvmroot</span>
<span class="err">rmdir /mnt/tmpvmroot</span>
</code></pre></div>

<h3>Start the VM</h3>
<div class="highlight"><pre><span></span><code><span class="err">virsh start somehostname</span>
</code></pre></div>

<h3>SSH into the VM</h3>
<p>I didn't specify any networking details to ubuntu-vm-builder, so the machine will boot and try to get an address from DHCP. By default you'll have a bridge device for libvirt called virbr0 and dnsmasq will be running, so watch syslog for the VM getting its address.</p>
<div class="highlight"><pre><span></span><code><span class="n">ssh</span> <span class="n">cmsj</span><span class="mf">@192.168.122</span><span class="p">.</span><span class="n">xyz</span>
</code></pre></div>

<p>you should now be in your VM! Now all you need to do is configure it to do things and then fix its networking. My plan is to switch the VMs to static IPs and then use NAT to forward connections from public IPs to the VMs, but you could bridge them onto the host's main ethernet device and assign public IPs directly to the VMs.</p>
  </div>

</article>


  </main>
    <footer>
      <div class="author__logo">
          <img src="http://cmsj.net/theme/images/logo.png" alt="logo">
      </div>
      <section class="author">
        <div class="author__name">
          <a href="http://cmsj.net/pages/about.html">Chris Jones</a>
          <p></p>
        </div>
        <div class="author__link">
          <ul>
            <li>
              <a href="https://twitter.com/cmsj" target="_blank" title="twitter">
                <i class="fab fa-twitter-square"></i>
              </a>
            </li>
            <li>
              <a href="https://github.com/cmsj" target="_blank" title="github">
                <i class="fab fa-github-square"></i>
              </a>
            </li>
            <li>
              <a href="http://cmsj.net/feeds/all.atom.xml" target="_blank" title="Feed">
                <i class="fas fa-rss-square"></i>
              </a>
            </li>
          </ul>
        </div>
      </section>
      <div class="ending-message">
        <p>&copy; Chris Jones. Powered by <a href="http://getpelican.com" target="_blank">Pelican</a>, Theme is using <a href="https://github.com/laughk/pelican-hss" target="_blank">HSS</a>. </p>
      </div>
    </footer>
</body>
</html>