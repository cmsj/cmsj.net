<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="http://cmsj.net/theme/css/style.less">
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->


  <link rel="icon" type="image/vnd.microsoft.icon" href="http://cmsj.net/">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto+Mono">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/fontawesome-all.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/hatena-bookmark-icon.css">

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chris Jones">
  <meta name="description" content="Posts and writings by Chris Jones">
  <meta name="og:site_name" content="cmsj.net">

  <!-- Twitter Card -->




  <link href="http://cmsj.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cmsj.net Atom" />


  <title>
    cmsj.net
&ndash; Posts by: Chris Jones  </title></head>

<body>
  <main>
    <header>
      <div class="site-name">
        <a href="http://cmsj.net">cmsj.net</a>
      </div>
      <p>
        <a href="http://cmsj.net/archives.html"><i class="fas fa-archive"></i> Archive</a>
&gt; Author: Chris Jones
      </p>
    </header>

<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/07/04/home-pro-part1-update.html">Home networking like a pro - Part 1.1 - Network Storage Redux</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Wed 04 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>Back in <a href="/2017/06/22/home-pro-part-1-nas.html">this post</a> I described having switched from a Mac Mini + DAS setup, to a Synology and an Intel NUC setup, for my file storage and server needs.</p>
<p>For a time it was good, but I found myself wanting to run more server daemons, and the NUC wasn't really able to keep up. The Synology was plodding along fine, but I made the decision to unify them all into a more beefy Linux machine.</p>
<p>So, I bought an AMD Ryzen 5 1600 CPU and an A320M motherboard, 16GB of RAM and a micro ATX case with 8 drive bays, and set to work. That quickly proved to be a disaster because Linux wasn't stable on the AMD CPU - I hadn't even thought to check, because why wouldn't Linux be stable on an x86_64 CPU in 2018?! With that lesson learned, I swapped out the board/CPU for an Intel i7-8700 and a Z370 motherboard.</p>
<p>I didn't go with FreeNAS as my previous post suggested I might, because ultimately I wanted complete control, so it's a plain Ubuntu Server machine that is fully managed by Ansible playbooks. In retrospect it was a mistake to try and delegate server tasks to an appliance like the Synology, and it was a further mistake to try and deal with that by getting the NUC - I should have just cut my losses and gone straight to a Linux server. Lesson learned!</p>
<p>Instead of getting lost in the weeds of purchase choices and justifications, instead let's look at some of the things I'm doing to the server with Ansible.</p>
<p>First up is root disk encryption - it's nice to know that your data is private when at rest, but a headless machine in a cupboard is not a fun place to be typing a password on boot. Fortunately I have two ways round this - firstly, a KVM (a Lantronix Spider) and secondly, one can add dropbear to an initramfs so you can ssh into the initramfs to enter the password.</p>
<p>Here's the playbook tasks that put dropbear into the initramfs:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dropbear-initramfs</span>
<span class="w">  </span><span class="nt">apt</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dropbear-initramfs</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install busybox-static</span>
<span class="w">  </span><span class="nt">apt</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox-static</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="c1"># This is necessary because of https://bugs.launchpad.net/ubuntu/+source/busybox/+bug/1651818</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add initramfs hook to fix cryptroot-unlock</span>
<span class="w">  </span><span class="nt">copy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/initramfs-tools/hooks/zz-busybox-initramfs-fix</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dropbear-initramfs/zz-busybox-initramfs-fix</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0744</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">update initramfs</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure dropbear-initramfs</span>
<span class="w">  </span><span class="nt">lineinfile</span><span class="p">:</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/dropbear-initramfs/config</span>
<span class="w">    </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;DROPBEAR_OPTIONS&#39;</span>
<span class="w">    </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;DROPBEAR_OPTIONS=&quot;-p</span><span class="nv"> </span><span class="s">31337</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">-j</span><span class="nv"> </span><span class="s">-k</span><span class="nv"> </span><span class="s">-I</span><span class="nv"> </span><span class="s">60&quot;&#39;</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">update initramfs</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add dropbear authorized_keys</span>
<span class="w">  </span><span class="nt">copy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/dropbear-initramfs/authorized_keys</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dropbear-initramfs/dropbear-authorized_keys</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0600</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">update initramfs</span>

<span class="c1"># The format of the ip= kernel parameter is: &lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gw-ip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;</span>
<span class="c1"># It comes from https://git.kernel.org/pub/scm/libs/klibc/klibc.git/tree/usr/kinit/ipconfig/README.ipconfig?id=HEAD</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure boot IP and consoleblanking</span>
<span class="w">  </span><span class="nt">lineinfile</span><span class="p">:</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/default/grub</span>
<span class="w">    </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;GRUB_CMDLINE_LINUX_DEFAULT&#39;</span>
<span class="w">    </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;GRUB_CMDLINE_LINUX_DEFAULT=&quot;ip=10.0.88.11::10.0.88.1:255.255.255.0:gnubert:enp0s31f6:none</span><span class="nv"> </span><span class="s">loglevel=7</span><span class="nv"> </span><span class="s">consoleblank=0&quot;&#39;</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">update grub</span>
</code></pre></div>

<p>While this does rely on some external files, the important one is <code>zz-busybox-initramfs-fix</code> which works around <a href="https://bugs.launchpad.net/ubuntu/+source/busybox/+bug/1651818">a bug</a> in the busybox build that Ubuntu is currently using. Rather than paste the whole script here, you can see it <a href="https://gist.github.com/cmsj/515fbf602f983e796ea11f95ce32d537">here</a>.</p>
<p>The last task in the playbook configures Linux to boot with a particular networking config on a particular NIC, so you can ssh in. Once you're in, just run <code>cryptsetup-unlock</code> and your encrypted root is unlocked!</p>
<p>Another interesting thing I'm doing, is using <a href="https://github.com/borgbackup">Borg</a> for some backups. It's a pretty clever backup system, and it works over SSH, so I use the following Ansible task to allow a particular SSH key to log in to the server as root, in a way that forces it to use Borg:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy ssh borg access</span>
<span class="w">  </span><span class="nt">authorized_key</span><span class="p">:</span>
<span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">    </span><span class="nt">key_options</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;command=&quot;/usr/bin/borg</span><span class="nv"> </span><span class="s">serve</span><span class="nv"> </span><span class="s">--restrict-to-path</span><span class="nv"> </span><span class="s">/srv/tank/backups/borg&quot;,restrict&#39;</span>
<span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ssh-rsa</span><span class="nv"> </span><span class="s">BLAHBLAH</span><span class="nv"> </span><span class="s">cmsj@foo&quot;</span>
</code></pre></div>

<p>Now on client machines I can run <code>borg create --exclude-caches --compression=zlib -v -p -s ssh://gnuborg:22/srv/tank/backups/borg/foo/backups.borg::cmsj-{utcnow} $HOME</code> and because <code>gnuborg</code> is defined in <code>~/.ssh/config</code> it will use all the right ssh options (username, hostname and the SSH key created for this purpose):</p>
<div class="highlight"><pre><span></span><code>Host gnuborg
  User root
  Hostname gnubert.local
  IdentityFile ~/.ssh/id_rsa_herborg
</code></pre></div>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/07/02/homebridge-server-monitoring.html">Homebridge server monitoring</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Mon 02 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="https://github.com/nfarina/homebridge">Homebridge</a> is a great way to expose arbitrary devices to Apple's HomeKit platform. It has helped bridge the Google Nest and Netgear Arlo devices I have in my home, into my iOS devices, since neither of those manufacturers appear to be interested in becoming officially HomeKit compatible.</p>
<p>London has been having a little bit of a heatwave recently and it got me thinking about the Linux server I have running in a closet under the stairs - it has pretty poor airflow available to it, and I didn't know how hot its CPU was getting.</p>
<p>So, by the power of JavaScript, Homebridge and Linux's <code>/sys</code> filesystem, I was able to quickly whip up <a href="https://github.com/cmsj/homebridge-linux-temperature">a plugin</a> for Homebridge that will read an entry from Linux's temperature monitoring interface, and present it to HomeKit. In theory I could use it for sending notifications, but in practice I'm doing that via <a href="https://grafana.com/">Grafana</a> - the purpose of getting the information in HomeKit is so I can ask Siri what the server's temperature is.</p>
<p>The configuration is very simple, allowing you to configure one temperature sensor per instance of the plugin (but you could define multiple instances in your Homebridge <code>config.json</code>):</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;accessory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;LinuxTemperature&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gnubert&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sensor_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/sys/bus/platform/devices/coretemp.0/hwmon/hwmon0/temp1_input&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;divisor&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="p">}</span>
</code></pre></div>

<p>(<code>gnubert</code> is the hostname of my server).</p>
<p>Below is a screenshot showing the server's CPU temperature mingling with all of the Nest and Arlo items :)</p>
<p><img alt="Screenshot" src="http://cmsj.net/2018-07-02-server-temp-homekit.jpg"></p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/06/19/trello-mac-app-automation.html">A little bit of automation of the Trello Mac App</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Tue 19 June 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="https://www.trello.com">Trello</a> have a Mac app, which I use for work and it struck me this morning that several recurring calendar events I have, which exist to remind me to review a particular board, would be much more pleasant if they contained a link that would open the board directly.</p>
<p>That would be easy if I used the Trello website, but I quite like the app (even though it's really just a browser pretending to be an app), so I went spelunking.</p>
<p>To cut a long story short, the Trello Mac app registers itself as a handler for <code>trello://</code> URLs, so if you take any <code>trello.com</code> board URL and replace the <code>https://</code> part with <code>trello://</code> you can use it as a link in your calendar (or anywhere else) and it will open the board in the app.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/06/15/homebridge-in-docker.html">Homebridge in Docker, an adventure in networking</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Fri 15 June 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="https://github.com/nfarina/homebridge">Homebridge</a> is a great way of connecting <a href="https://www.npmjs.com/search?q=homebridge">loads</a> of devices that don't support Apple's <a href="https://www.apple.com/uk/ios/home/">HomeKit</a>, to your iOS devices. It consists of a daemon that understands the <a href="https://developer.apple.com/support/homekit-accessory-protocol/">HomeKit Accessory Protocol</a> and <a href="https://www.npmjs.com/search?q=homebridge">many plugins</a> that talk to other devices/services.</p>
<p>My home server is running Ubuntu, so installing Homebridge is fairly trivial, except I run all my services in <a href="https://www.docker.com">Docker</a> containers. To make things even more fun, I don't build or manage the containers by hand - the building is done by <a href="https://hub.docker.com/u/cmsj/">Docker Hub</a> and the containers are deployed and managed by <a href="https://www.ansible.com/">Ansible</a>.</p>
<p>So far so good, except that for a long time Homebridge used <a href="https://www.avahi.org/">Avahi</a> (an Open Source implementation of Apple's Bonjour host/service discovery protocol) to announce its devices. That presented a small challenge in that I didn't want to have Avahi running only in that container, so I had to bind mount <code>/var/run/avahi-daemon/</code> into the container.</p>
<p>I recently rebuilt my Homebridge container to pull it up to the latest versions of Homebridge and the plugins I use, but it was no longer announcing devices on my LAN, and there were no mentions of Avahi in its log. After some digging, it turns out that the HomeKit Accessory Protocol (HAP) library that Homebridge uses, now instantiates its own multicast DNS stack rather than using Avahi.</p>
<p>Apart from not actually working, this was great news, I could remove the <code>/var/run</code> bind mount from the container, making things more secure, I just needed to figure out why it wasn't showing up.</p>
<p>The HAP library that Homebridge uses, ends up depending on <a href="https://github.com/mafintosh/multicast-dns">this library</a> to implement mDNS and it makes <a href="https://github.com/mafintosh/multicast-dns/blob/master/index.js#L147">a very simple</a> decision about which network interface it should use. In my case, it was choosing the <code>docker0</code> bridge interface which explicitly isn't connected to the outside world. With no configuration options at the Homebridge level to influence the choice of interface, I had to solve the problem at the Docker network layer.</p>
<p>So, the answer was the following Ansible task to create a Docker network that is attached to my LAN interface (<code>bridge0</code>) and give it a small portion of a reserved segment in the IP subnet I use:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure LANbridge network</span>
<span class="w">  </span><span class="nt">docker_network</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lanbridge</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan</span>
<span class="w">    </span><span class="nt">driver_options</span><span class="p">:</span>
<span class="w">      </span><span class="nt">parent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge0</span>
<span class="w">    </span><span class="nt">ipam_options</span><span class="p">:</span>
<span class="w">      </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;10.0.88.0/24&#39;</span>
<span class="w">      </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;10.0.88.1&#39;</span>
<span class="w">      </span><span class="nt">iprange</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;10.0.88.32/29&#39;</span>
</code></pre></div>

<p>then change the task for the Homebridge container to use this network:</p>
<div class="highlight"><pre><span></span><code>  network_mode: lanbridge
</code></pre></div>

<p>and now Homebridge is up to date, and working, plus I have a Docker network I can use in the future if any other containerised services need to be very close to the LAN.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/06/15/systemd-remote-syslog.html">Receiving remote syslog events with systemd</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Fri 15 June 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="https://www.freedesktop.org/wiki/Software/systemd/">Systemd</a> includes <code>journald</code>, a fancy replacement for the venerable <code>syslog</code> daemon (and its descendents, <code>syslog-ng</code> and <code>rsyslog</code>).</p>
<p>One interesting, but frustrating, decision by <code>journald</code>'s maintainers is that it does not speak the syslog network protocol, so it's unable to receive remote syslog events. Remote syslog is a tremendously useful feature for aggregating log data from many hosts on a network - I've always used it so my network devices can log somewhere I'm likely to look at, but I haven't been able to do that since <code>journald</code> arrived.</p>
<p>While there are many ways to skin this goose, the method I've chosen is a tiny Python daemon that listens on syslog's UDP port (514), does minimal processing of the data and then feeds it into <code>journald</code> via its API, to get the data as rich as possible (since one of <code>journald</code>'s strengths is that it can store a lot more metadata about a log entry).</p>
<p>So, <a href="https://gist.github.com/cmsj/e03b6d28325ce5c3d5b255256278a330">here is the source</a> for the daemon, and <a href="https://gist.github.com/cmsj/71f987d1129c5dc693243dd1aa5f8f4f">here is the systemd service file</a> that manages it - note that it runs as an unprivileged user, with the sole privilege escalation of being able to bind to low port numbers (something only root can do normally).</p>
<p>The daemon is certainly not perfect (patches welcome!), but it works. Here is a <code>journald</code> log entry from one of my UniFi access points:</p>
<div class="highlight"><pre><span></span><code><span class="n">Jun</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">21</span><span class="err">:</span><span class="mi">28</span><span class="err">:</span><span class="mi">26</span><span class="w"> </span><span class="n">gnubert</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;U7PG2,802aa8d48ab3,v3.9.27.8537&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">23506</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="nl">kernel</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">4251792.410000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">wifi1</span><span class="o">]</span><span class="w"> </span><span class="nl">FWLOG</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">58855274</span><span class="o">]</span><span class="w"> </span><span class="n">BEACON_EVENT_SWBA_SEND_FAILED</span><span class="w"> </span><span class="p">(</span><span class="w">  </span><span class="p">)</span>
</code></pre></div>

<p>(the more syslog-obsessed among you will notice that I'm setting the <code>identifier</code> to the hostname of the device that sent the message. Internally, the <code>facility</code> is mapped correctly, as is the <code>priority</code>. The text of the message then appears, prepended by its <code>identifier</code>.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/04/13/lua-stack-adventures.html">Adventures in Lua stack overflows</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Fri 13 April 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="http://www.hammerspoon.org">Hammerspoon</a> is heavily dependent on <a href="http://www.lua.org">Lua</a> - it's the true core of the application, so it's unavoidable that we have to interact with Lua's C API in a lot of places. If you've never used it before, Lua's C API is designed to be very simple to integrate with other code, but it also places a fairly high burden on developers to integrate it properly.</p>
<p>One of the ways that Lua remains simple is by being stack based - when you give Lua a C function and make it available to call from Lua code, you have to conform to a particular way of working. The function arguments supplied by the user will be presented to you on a stack, and when your C code has finished its work, the return values must have been pushed onto the stack. Here's an example:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">someUsefulFunction</span><span class="p">(</span><span class="n">lua_State</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fetch our first argument from the stack</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">someNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Fetch our second argument from the stack</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">someString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Do some useful work here */</span>

<span class="w">    </span><span class="c1">// Push two return values onto the stack and return 2 so Lua knows how many return values we provided</span>
<span class="w">    </span><span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;some result text&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>All simple enough.</p>
<p>In this scenario of calling from Lua‚ÜíC, Lua creates a pseudo-stack for you, so while it's good practice to keep the stack neat and tidy (i.e. remove things from it that you don't need), it's not critical because apart from the return values, the rest of the stack is thrown away. That pseudo-stack only has 20 slots by default though, so if you're pushing a lot of return arguments, or using the stack for other things, you may need to use <code>lua_checkstack()</code> to grow it larger, up to the maximum (2048 slots).</p>
<p>Where things get more interesting, is when you're interacting with the Lua stack without having crossed a Lua‚ÜíC boundary. For example, maybe you're in a callback function that's been triggered by some event in your C program, and now you need to call a Lua function that the user gave you earlier. This might look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">globalLuaFunction</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">someCallback</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">aValue</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">aString</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fetch a pointer to the shared Lua state object</span>
<span class="w">    </span><span class="n">lua_State</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_shared_lua_state_provider</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Push onto the stack, the Lua function previously supplied by the user, from Lua&#39;s global registry</span>
<span class="w">    </span><span class="n">lua_rawgeti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span><span class="w"> </span><span class="n">globalLuaFunction</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Push the two arguments for the Lua function</span>
<span class="w">    </span><span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">aValue</span><span class="p">);</span>
<span class="w">    </span><span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">aString</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Call the Lua function, telling Lua to expect two arguments</span>
<span class="w">    </span><span class="n">lua_call</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Slightly more complex than the last example, but still manageable. Unfortunately in practice this is a fairly suboptimal implementation of a C‚ÜíLua call - storing things in the <code>LUA_REGISTRYINDEX</code> table is fine, but it's often nicer to use multiple tables for different things. The big problem here though is that <code>lua_call()</code> doesn't trap errors. If the Lua code raises an exception, Lua will <code>longjmp</code> to a panic handler and <code>abort()</code> your app.</p>
<p>So, writing this a bit more completely, we get:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">luaCallbackTable</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">globalLuaFunctionRef</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">someCallback</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">aValue</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">aString</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fetch a pointer to the shared Lua state object</span>
<span class="w">    </span><span class="n">lua_State</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_shared_lua_state_provider</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Push onto the stack, the table we keep callback references in, from Lua&#39;s global registry</span>
<span class="w">    </span><span class="n">lua_rawgeti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span><span class="w"> </span><span class="n">luaCallbackTable</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Push onto the stack, from our callback reference table, the Lua function previously supplied by the user</span>
<span class="w">    </span><span class="n">lua_rawgeti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">globalLuaFunctionRef</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Push the two arguments for the Lua function</span>
<span class="w">    </span><span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">aValue</span><span class="p">);</span>
<span class="w">    </span><span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">aString</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Protected call to the Lua function, telling Lua to expect two arguments</span>
<span class="w">    </span><span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Ok so this is looking better, we have our own table for neatly storing function references and we'll no longer <code>abort()</code> if the Lua function throws an error.</p>
<p>However, we now have a problem, we're leaking at least one item onto Lua's stack and possibly two. Unlike in the Lua‚ÜíC case, we are not operating within the safe confines of a pseudo-stack, so anything we leak here will stay permanently on the stack, and at some point that's likely to cause the stack to overflow.</p>
<p>Now here is the kicker - stack overflows are really hard to find by default, you don't typically get a nice error, your program will simply leak stack slots until the stack overflows, far from the place where the leak is happening, then segfault, and your backtraces will have very normal looking Lua API calls in them.</p>
<p>If we were to handle the stack properly, the above could would actually look like this (and note that we've gone from four Lua API calls in the first C‚ÜíLua example, to eight here):</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">luaCallbackTable</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">globalLuaFunctionRef</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">someCallback</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">aValue</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">aString</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fetch a pointer to the shared Lua state object</span>
<span class="w">    </span><span class="n">lua_State</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_shared_lua_state_provider</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Find luaCallbackTable in the Lua registry, and push it onto the stack</span>
<span class="w">    </span><span class="n">lua_rawgeti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span><span class="w"> </span><span class="n">luaCallbackTable</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Find globalLuaFunctionRef in luaCallbackTable, and push it onto the stack</span>
<span class="w">    </span><span class="n">lua_rawgeti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">globalLuaFunctionRef</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Remove luaCallbackTable from the stack *THIS WAS LEAKED IN THE ABOVE EXAMPLE*</span>
<span class="w">    </span><span class="n">lua_remove</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">-2</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Push the two arguments for the Lua function</span>
<span class="w">    </span><span class="n">lua_pushinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">aValue</span><span class="p">);</span>
<span class="w">    </span><span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">aString</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Fetch the Lua error message from the stack</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">someError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">someError</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Remove the Lua error message from the stack *THIS WAS LEAKED IN THE ABOVE EXAMPLE*</span>
<span class="w">        </span><span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Hammerspoon has been having problems like this for the last few months - lots of crash reports that on the surface, look like completely valid code was executing. I have to admit that it took me a lot longer than it should have, to realise that these were Lua stack overflows rather than my initial suspicion (C heap corruption), but we figured it out eventually and have hopefully fixed all of the leaks.</p>
<p>So, how did we discover that the problem was stack overflows, and how did we discover where all of the leaks were without manually auditing all of the places where we make C‚ÜíLua transitions (of which there are over 100). The answer to the first question is very simple, by defining <code>LUA_USE_APICHECK</code> when compiling Lua, it will do a little extra work to verify its consistency. Crucially, this includes calling <code>abort()</code> with a helpful message when the stack overflows. We turned this on for developers in March and then released 0.9.61 with it enabled, in early April. It's not normally recommended to have the API checker enabled in production because it calls <code>abort()</code>, but we felt that it was important to get more information about the crashes we couldn't reproduce.</p>
<p>Within a few days we started getting crash reports with the words <code>stack overflow</code> in them (as well as a few other errors, which we were able to fix), but that is only half the battle.</p>
<p>Having discovered that we did definitely have a stack leak somewhere, how did we discover where it was? This did involve a little brute force effort, but thankfully not a full manual audit of all 107 C‚ÜíLua call sites. Instead, I wrote two macros:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define _lua_stackguard_entry(L) int __lua_stackguard_entry=lua_gettop(L);</span>
<span class="cp">#define _lua_stackguard_exit(L) assert(__lua_stackguard_entry == lua_gettop(L));</span>
</code></pre></div>

<p>These are very simple to use - you call <code>_lua_stackguard_entry()</code> just after you've obtained a pointer to the Lua state object, and then you call <code>_lua_stackguard_exit()</code> at every point where the function can return after that. It records the size of the stack (<code>lua_gettop()</code>) at the entry point and <code>assert()</code>s that it's the same at the exit point (<code>assert()</code> also calls <code>abort()</code> if something is wrong, so now we would get crash logs with the crash in the actual function where the leak is happening).
These entry/exit calls were then added to all 107 call sites 4 days after the 0.9.61 was released and I spent 3 evenings testing or manually verifying every site, before releasing 0.9.65 (0.9.62-0.9.64 fixed some of the other bugs found by the API checker in the mean time).</p>
<p>At the time of writing we're only 24 hours past the release of 0.9.65, but so far things are looking good - no strange Lua segfault crash reports as yet. There was one issue found today where I'd placed a <code>_lua_stackguard_exit()</code> call after a C statement that seemed unimportant, but actually caused an important object to be freed, but that is <a href="https://github.com/Hammerspoon/hammerspoon/commit/95a13554c65568aca2ee6db040895c6345b01b50">already fixed</a> and will be included in 0.9.66.</p>
<p>Assuming we have now fixed the problem, after months of head-scratching, and a few weeks of research, testing and coding, it turns out that across the 107 call sites we only had two stack leaks - <a href="https://github.com/Hammerspoon/hammerspoon/commit/2b7abf2b33e3ddb17d87e548725959a8bba1ac40#diff-d0e4e7c56ae114494056acc9758d118fR797">one was in the code that handles tab completion in Hammerspoon's Console window</a>, and <a href="https://github.com/Hammerspoon/hammerspoon/commit/f199351538d7b81bd4a01f349ddeb2e33e76d8e7">the other was in <code>hs.notify</code></a>. Hopefully you're all enjoying a more stable Hammerspoon experience, but I think we'll be leaving both the API checker and the stack guard macros enabled since they make it very easy to find/fix these sorts of bugs. I'd rather get a smaller number of crashes sooner, than have more months of head-scratching!</p>
<p>Discuss on <a href="https://twitter.com/cmsj/status/984592229472833536">Twitter</a> | Discuss on <a href="https://news.ycombinator.com/item?id=16826199">Hacker News</a></p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2017/11/27/airpod-battery-ear-data.html">Getting battery data from AirPods in macOS</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Mon 27 November 2017</p>
    </p>
  </div>
  <div class="article__text">
    <p>A recent <a href="https://github.com/Hammerspoon/hammerspoon/issues/1608">feature request</a> for <a href="http://www.hammerspoon.org">Hammerspoon</a> requested that we add support for reading battery information about AirPods (<a href="http://amzn.to/2zxsZSt">UK</a> <a href="http://amzn.to/2zxl2wn">US</a>).</p>
<p>Unfortunately because their battery status is quite complex (two earbuds and the case), this information is not reported via the normal IOKit APIs, but with a bit of poking around in the results of <a href="http://stevenygard.com/projects/class-dump/">class-dump</a> for macOS High Sierra I was able to find some relevant methods/properties on <a href="https://developer.apple.com/documentation/iobluetooth/iobluetoothdevice">IOBluetoothDevice</a> that let you read information about the battery level of individual AirPods and the case, plus determine which of the buds are currently in an ear!</p>
<p>So, the next release of Hammerspoon should include <a href="https://github.com/Hammerspoon/hammerspoon/commit/e5738e8231b90b0506bbacf62cef6491364c5c22">this code</a> to expose all of this information neatly via <code>hs.battery.privateBluetoothBatteryInfo()</code> üòÅ</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2017/07/28/happy-10th-terminator.html">Happy 10th Birthday Terminator!</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Fri 28 July 2017</p>
    </p>
  </div>
  <div class="article__text">
    <p>Today marks 10 years since the <a href="https://launchpad.net/terminator/+milestone/0.1">very first public release</a> of <a href="https://gnometerminator.blogspot.co.uk/p/introduction.html">Terminator</a>, a multiplexing terminal emulator project.</p>
<p>I started working on Terminator as a simple way to get 4 terminals to not overlap on my laptop screen. In the following years it grew many features and attracted a userbase I am very proud of.</p>
<p>As much as I would like to, I cannot claim most of the credit for Terminator surviving for a decade - I stepped away from the project a few years ago and handed the reigns over to Stephen Boddy at a very crucial time - gtk2 was becoming ever more obsolete and our work on a gtk3 port was very incomplete. Stephen has driven the project forward and it now has a very good gtk3 version :)</p>
<p>So, thank you to Stephen and everybody else who contributed code/docs/translations/suggestions/bugs/etc over the last 10 years (you can see the most active folk <a href="https://launchpad.net/terminator/+topcontributors">here</a>).</p>
<p>I'd also like to note that according to Ubuntu's <a href="http://popcon.ubuntu.com">Popularity Contest</a> data, Terminator is installed on at least 56000 Ubuntu machines. Debian also has PopCon data, but the numbers there are <a href="https://qa.debian.org/popcon.php?package=terminator">a little less impressive</a> ;)</p>
<p>This was the first project of mine that reached any kind of significant audience, and is the first project of mine to have achieved a decade of active maintenance, so I am feeling pretty happy today!</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2017/06/30/usb-c-is-awful.html">USB Type C is awful</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Fri 30 June 2017</p>
    </p>
  </div>
  <div class="article__text">
    <p>Intentionally inflammatory title there, but there are some valid reasons to be annoyed at USB Type C.</p>
<p>Firstly, I have discovered (the hard way) that although there are many cables on sale, the majority of Type C cables do not support even USB 3.0 speeds (so 5Gb/s) let alone USB 3.1gen2 (so 10Gb/s) speeds. They are actually USB 2.0 (so 480Mb/s) cables.</p>
<p>I can understand that some <em>devices</em> with Type C connectors may only need USB 2.0 speeds, but for the <em>cables</em> to not all be USB 3.x seems crazy to me. Even <a href="https://www.apple.com/shop/product/MLL82AM/A/usb-c-charge-cable-2-m">Apple is doing this</a> - the charging cables for MacBooks (12" and Pros) with Type C ports, only support USB 2.0 speeds. If I had to guess, I'd say it's because they wanted the cables to be thin and easily bendable, which full USB 3.1 cables tend not to be.</p>
<p>Secondly, unlike Type A, which marks USB 3.x cables by having blue plastic inside the connectors, there is no way to tell what speed a Type C cable is by looking at it.</p>
<p>Thirdly, and perhaps most importantly, USB Type C is a <em>vastly</em> more powerful beast than previous versions - a modern Type C port can be capable of:</p>
<ul>
<li>40Gb/s Thunderbolt 3</li>
<li>DisplayPort</li>
<li>10Gb/s USB 3.1gen2</li>
<li>100W of (actively negotiated) power delivery in either direction</li>
</ul>
<p>The DisplayPort "alternate mode" can deliver 4K at 60Hz with USB3.1 at the same time, or 5K with USB2.0 at the same time, or 8K (compressed). When used as Thunderbolt, Type C can carry 5K video as well as the PCI data.</p>
<p>So while one tiny <em>connector</em> can do a whole bunch of really impressive things, the <em>cables</em> are now expected to do vastly more than even USB3.0 Type A cables, let alone USB 2.0, and it seems like that advanced capability isn't currently aligned with the history of USB as being an ultra-cheap, mass market affair.</p>
<p>Various awesome folk have put together <a href="https://docs.google.com/spreadsheets/u/1/d/1vnpEXfo2HCGADdd9G2x9dMDWqENiY2kgBJUu29f_TX8/pubhtml#">a spreadsheet</a> of the chargers/cables they've tested, and it seems like a serious chunk of the Type C cables currently on the market, are junk. This is bad for everyone, especially users, who can buy what looks like the right cable, only to discover that their devices either don't work at all, or work to slowly, or won't charge properly.</p>
<p>This post exists because I needed a USB3.0, three metre, Type A to Type C cable, and I bought one on Amazon, only to discover that it only supported USB2.0. After <em>far</em> too much searching, I eventually found an Anker cable which meets my requirements:</p>
<ul>
<li>3m/10ft: <a href="http://amzn.to/2t7scp2">UK</a>|<a href="http://amzn.to/2trgUyd">US</a></li>
<li>2m/6ft: <a href="http://amzn.to/2t82PU0">UK</a>|<a href="http://amzn.to/2s8DRm8">US</a></li>
<li>1m/3ft: <a href="http://amzn.to/2stsrbV">UK</a>|<a href="http://amzn.to/2snLzwR">US</a></li>
</ul>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2017/06/22/home-pro-part-1-nas.html">Home networking like a pro - Part 1 - Network Storage</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Thu 22 June 2017</p>
    </p>
  </div>
  <div class="article__text">
    <h2>Introduction</h2>
<p>This is part one in a series of posts about some hardware I recommend (or otherwise!) for people who want to bring some semi-professional flair to their home network.</p>
<p>The first topic is storage - specifically, Network Attached Storage.</p>
<h2>Background</h2>
<p>For the last few years, I was running a Mac Mini with two 3TB drives in a RAID1 array in a LaCie 2big Thunderbolt chassis (<a href="https://www.amazon.com/gp/product/B00KQD0HM2/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B00KQD0HM2&amp;linkCode=as2&amp;tag=cmsj-20&amp;linkId=263d4ed10fb9c73f39e787d9266f3851">US</a> <a href="https://www.amazon.co.uk/gp/product/B00KYFU5YM/ref=as_li_tl?ie=UTF8&amp;camp=1634&amp;creative=6738&amp;creativeASIN=B00KYFU5YM&amp;linkCode=as2&amp;tag=cmsj-21&amp;linkId=9290f58318a0bfd748de49c6e53c8f2c">UK</a>), with the Mac running macOS Server to provide file sharing (AFP and SMB), and Time Machine backups for the rest of the network.</p>
<p>This was a very nice solution, in that the Mac was a regular computer, so I could make it do whatever I wanted, but it did have the drawbacks that the Thunderbolt chassis only had two drive bays, and I had trouble getting the Mac to run reliably for months at a time (I ran into GPU related kernel panics, perhaps because it was attached to a TV rather than a monitor).</p>
<p>Around the time I was selecting the Mac/LaCie, most NAS devices in a similar price range were very underpowered ARM devices, and could do little more than share files, but in 2017 almost all NAS devices are much more powerful x86 devices that often have extensive featuresets (e.g. running containers, VMs, hardware accelerated video transcoding, etc.) so I decided it was time to switch.</p>
<h2>Solution</h2>
<p>I ended up choosing a Synology DS916+ (<a href="https://www.amazon.com/gp/product/B01EMZHLZU/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B01EMZHLZU&amp;linkCode=as2&amp;tag=cmsj-20&amp;linkId=4bc9ac2f2590480e49aef6993329eb39">US</a> <a href="https://www.amazon.co.uk/gp/product/B01EMZHLZU/ref=as_li_tl?ie=UTF8&amp;camp=1634&amp;creative=6738&amp;creativeASIN=B01EMZHLZU&amp;linkCode=as2&amp;tag=cmsj-21&amp;linkId=a5a66e7532a51fb5478e07202daa05d2">UK</a>), popped one of the 3TB drives (Western Digital Red (<a href="https://www.amazon.com/gp/product/B008JJLW4M/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B008JJLW4M&amp;linkCode=as2&amp;tag=cmsj-20&amp;linkId=d2d3d7db9bcd9bdf879a213d405a343b">US</a> <a href="https://www.amazon.co.uk/gp/product/B008JJLW4M/ref=as_li_tl?ie=UTF8&amp;camp=1634&amp;creative=6738&amp;creativeASIN=B008JJLW4M&amp;linkCode=as2&amp;tag=cmsj-21&amp;linkId=c644f89fe12d6b3d39794ca77b65cb9a">UK</a>)) out of the LaCie and into the Synology, and set about migrating my data over. I then moved the other drive, and put in two more 3TB drives, all of which are running as a single Synology Hybrid RAID volume with a BTRFS filesystem (note that the Hybrid RAID really seems to just be RAID5).</p>
<p>I configured the Synology to serve files over both AFP and SMB, and enabled its support for Time Machine via AFP. I was also able to connect both of its Ethernet ports to my switch (a ZyXEL GS1900 24 port switch, which I will cover in an upcoming post) and enabled LACP on each end to bond the two connections into a single 2Gb link.</p>
<p>So, how did it work out?</p>
<p>The AFP file sharing is great, and works flawlessly. SMB is a little more complex, because recent versions of macOS tend to enforce encryption on SMB connections, which makes them go much slower, but this <a href="https://dpron.com/os-x-10-11-5-slow-smb/">can be disabled</a>. I tested Time Machine over SMB, which is officially supported by Synology, but is a very recent addition, and it proved to be unreliable, so that is staying on AFP for now.</p>
<p>Something I was particularly keen on, with the Synology, was that it has an "app store" and one of the available applications is Docker. I was running a few UNIX daemons on the Mac Mini which I wanted to keep, and Docker containers would be perfect for them, however, I discovered that the version of Docker provided by Synology is pretty old and I ran into a strange bug that would cause dockerd to consume all available CPU cycles.</p>
<p>For now, the containers are running on an Intel NUC (which will also be covered in an upcoming post) and the Synology is focussed on file sharing.</p>
<h2>Open Source</h2>
<p>Synology's NAS products are based on Linux, Samba, netatalk and a variety of other Open Source projects, with their custom management GUI on top. They do <a href="https://sourceforge.net/projects/dsgpl/files/Synology%20NAS%20GPL%20Source/">publish source</a>, but it's usually a little slow to arrive on the site, and it's not particularly easy (or in some cases even possible) to rebuild in a way that lets you actively customise the device.</p>
<h2>Conclusion</h2>
<p>Overall, I like the Synology, but I think if I'd known about the Docker issue, I might have built my own machine and put something like <a href="http://www.freenas.org/">FreeNAS</a> on it. More work, less support, but more flexibility.</p>
<p>The recent 5-8 drive Synologies now support running VMs, which seems like a very interesting prospect, since it ought to isolate you from Synology's choices of software versions.</p>
  </div>
</article>

<div class="pagination">
    <ul>
        <li class="pagination__prev">
            <a href="http://cmsj.net/author/chris-jones.html">&laquo;</a>
        </li>



          <li>
            <a  href="http://cmsj.net/author/chris-jones.html">1</a>
          </li>


          <li>
            <a class="pagination__page--current" href="http://cmsj.net/author/chris-jones2.html">2</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones3.html">3</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones4.html">4</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones5.html">5</a>
          </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones23.html">23</a>
          </li>

        <li class="pagination__next">
            <a href="http://cmsj.net/author/chris-jones3.html">&raquo;</a>
        </li>
    </ul>
</div>

  </main>
    <footer>
      <div class="author__logo">
          <img src="http://cmsj.net/theme/images/logo.png" alt="logo">
      </div>
      <section class="author">
        <div class="author__name">
          <a href="http://cmsj.net/pages/about.html">Chris Jones</a>
          <p></p>
        </div>
        <div class="author__link">
          <ul>
            <li>
              <a href="https://twitter.com/cmsj" target="_blank" title="twitter">
                <i class="fab fa-twitter-square"></i>
              </a>
            </li>
            <li>
              <a href="https://github.com/cmsj" target="_blank" title="github">
                <i class="fab fa-github-square"></i>
              </a>
            </li>
            <li>
              <a href="http://cmsj.net/feeds/all.atom.xml" target="_blank" title="Feed">
                <i class="fas fa-rss-square"></i>
              </a>
            </li>
          </ul>
        </div>
      </section>
      <div class="ending-message">
        <p>&copy; Chris Jones. Powered by <a href="http://getpelican.com" target="_blank">Pelican</a>, Theme is using <a href="https://github.com/laughk/pelican-hss" target="_blank">HSS</a>. </p>
      </div>
    </footer>
</body>
</html>