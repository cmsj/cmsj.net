<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="../theme/css/style.less">
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="icon" type="image/vnd.microsoft.icon" href="../">
  <link rel="stylesheet" type="text/css" href="../theme/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/fontawesome-all.min.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/hatena-bookmark-icon.css">


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chris Jones">
  <meta name="description" content="Posts and writings by Chris Jones">

  <link href="http://cmsj.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cmsj.net Atom" />


  <title>
    cmsj.net
&ndash; Posts by: Chris Jones  </title>

</head>

<body>
  <main>
    <header>
      <div class="site-name">
        <a href="/">cmsj.net</a>
      </div>
      <p>
        <a href="../archives.html"><i class="fas fa-archive"></i> Archive</a>
&gt; Author: Chris Jones
      </p>
    </header>

<article>
  <div class="article__title">
    <h1><a href="../2010/08/04/adventures-in-puppet.html">Adventures in Puppet</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 04 August 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I'm very slowly learning and exploring the fascinating world of Puppet for configuration management. As I go I'm going to try and blog about random things I discover. Partially for my own future reference, partially to help me crystalise my knowledge and partially to help you.
The first post is coming up immediately, I'm just writing this post as an opening bookend :)</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/08/04/adventures-in-puppet-concat-module.html">Adventures in Puppet: concat module</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 04 August 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>R.I. Pienaar has a Puppet module on github called "concat". Its premise is very simple, it just concatenates fragments of text together into a particular file.
I'm sure that a more seasoned Puppet veteran would have had this running in no time, but since it introduced some new concepts for me, I thought I'd throw up some notes of how I'm using it. I was particularly interested in an example usage I saw which lists the puppet modules a system is using in its /etc/motd, but because of the way Ubuntu handles constructing the motd, I needed to slightly rework the example. In Ubuntu, the /etc/motd file is constructed dynamically when you log in - this is done by pam_motd which executes the scripts in /etc/update-motd.d/. One of those scripts (99-footer) will simply append the contents of /etc/motd.tail to /etc/motd after everything else - my example will take advantage of this. If you are already using motd.tail, you could just have this puppet system write to a different file and then drop another script into /etc/update-motd.d/ to append the contents of that different file.
This is what I did:</p>
<ul>
<li>git clone http://github.com/ripienaar/puppet-concat.git</li>
<li>Move the resulting git branch to /etc/puppet/modules/concat and add it to my top-level site manifest that includes modules</li>
<li>Create a class to manage /etc/motd.tail. In my setup this ends up being /etc/puppet/manifests/classes/motd.pp, which is included by my default node, but your setup is probably different. This is what my class looks like:</li>
</ul>
<div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="na">motd</span> <span class="p">{</span>
           <span class="k">include</span> <span class="na">concat</span><span class="p">::</span><span class="na">setup</span>
           <span class="nv">$motdfile</span> <span class="o">=</span> <span class="s">&quot;/etc/motd.tail&quot;</span>

           <span class="na">concat</span><span class="p">{</span><span class="nv">$motdfile:</span>
                   <span class="na">owner</span> <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
                   <span class="na">group</span> <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
                   <span class="na">mode</span> <span class="o">=&gt;</span> <span class="mi">644</span>
           <span class="p">}</span>

           <span class="na">concat</span><span class="p">::</span><span class="na">fragment</span><span class="p">{</span><span class="s">&quot;motd_header&quot;</span><span class="p">:</span>
                   <span class="na">target</span> <span class="o">=&gt;</span> <span class="nv">$motdfile,</span>
                   <span class="na">content</span> <span class="o">=&gt;</span> <span class="s">&quot;\nPuppet modules: &quot;</span><span class="p">,</span>
                   <span class="na">order</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
           <span class="p">}</span>

           <span class="na">concat</span><span class="p">::</span><span class="na">fragment</span><span class="p">{</span><span class="s">&quot;motd_footer&quot;</span><span class="p">:</span>
                   <span class="na">target</span> <span class="o">=&gt;</span> <span class="nv">$motdfile,</span>
                   <span class="na">content</span> <span class="o">=&gt;</span> <span class="s">&quot;\n\n&quot;</span><span class="p">,</span>
                   <span class="na">order</span> <span class="o">=&gt;</span> <span class="mi">90</span><span class="p">,</span>
           <span class="p">}</span>
    <span class="p">}</span><span class="c"></span>

<span class="c">    # used by other modules to register themselves in the motd</span>
    <span class="k">define</span> <span class="na">motd</span><span class="p">::</span><span class="na">register</span><span class="p">(</span><span class="nv">$content=&quot;&quot;,</span> <span class="nv">$order=20)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="nv">$content</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
          <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$name</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$content</span>
       <span class="p">}</span>

       <span class="na">concat</span><span class="p">::</span><span class="na">fragment</span><span class="p">{</span><span class="s">&quot;motd_fragment_$name&quot;</span><span class="p">:</span>
          <span class="na">target</span>  <span class="o">=&gt;</span> <span class="s">&quot;/etc/motd.tail&quot;</span><span class="p">,</span>
          <span class="na">content</span> <span class="o">=&gt;</span> <span class="s">&quot;$body &quot;</span><span class="p">,</span>
          <span class="na">order</span> <span class="o">=&gt;</span> <span class="nv">$order</span>
       <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>So that's quite a mouthful. Let's break it down:
 * We have to include concat::setup so the concat module can...set... up :)
 * We then set a variable pointing at the location of the file we want to manage
 * We then instantiate the concat module for the file we want to manage and set properties like the ownership/mode
 * We then call the concat::fragment function for two specific fragments we want in the output - a header and a footer (although I do this on a single line, so it's the phrase "Puppet modules" and "\n\n" respectively). They're forced to be header/footer by the "order" parameter - by making sure we use a low number for the header and a high number for the footer, we get the layout we expect.
 * Outsite this class we define a function motd::register which other modules will call and the content they supply will be handed to concat::fragment with a default order parameter of 20 (which is higher than the value we used for the header and lower than the footer one).</p>
<p>Finally, in each of my modules I include the line:
    <code>motd::register{"someawesomemodule":}</code></p>
<p>and now when I ssh to a node, I see a line like:
    Puppet modules: web ssh</p>
<p>It's a fairly simple little thing, but quite pleasing and from here out it's almost zero effort - just adding the motd::register calls to each module.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/08/04/adventures-in-puppet-tangled-strings.html">Adventures in Puppet: Tangled Strings</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 04 August 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I am trying to do as much management on my new VM servers as possible with Puppet, but these are machines I still frequently log on to, and not everything is managed by Puppet, so it's entirely possible that in a fit of forgetfulness I will start editing a file that Puppet is managing and then be annoyed when my changes are lost next time Puppet runs.
Since prior preparation and planning prevents pitifully poor performance, I decided to do something about this.
Thus, I present a VIM plugin called TangledStrings, which I'm distributing as a Vimball (.vba) you can download from its <a href="http://launchpad.net/tangledstrings" title="TangledStrings">project page</a> on Launchpad. For more information on Vimball formatted plugins, see <a href="http://vimdoc.sourceforge.net/htmldoc/pi_vimball.html" title="Vimball Documentation">this page</a>. To install the plugin, simply:</p>
<ul>
<li>vim tangledstrings.vba</li>
<li>Follow the instructions from Vimball to type: :so %</li>
</ul>
<p>By default, TangledStrings will show a (configurable) warning message when you load a Puppet-owned file:
<a href="http://www.tenshu.net/wp-content/uploads/2010/08/puppetstrings_alert.png"><img src="http://www.tenshu.net/wp-content/uploads/2010/08/puppetstrings_alert.png" title="tangledstrings_alert" class="aligncenter size-full wp-image-11573" width="403" height="127" /></a>
This message can be disabled, and you can choose to enable a persistent message in the VIM status line instead:
<a href="http://www.tenshu.net/wp-content/uploads/2010/08/tangledstrings_statusline.png"><img src="http://www.tenshu.net/wp-content/uploads/2010/08/tangledstrings_statusline.png" title="tangledstrings_statusline" class="aligncenter size-full wp-image-11574" width="403" height="127" /></a>
(or you could choose to enable both of these methods).
For more information, see the documentation included in the Vimball which you can display with the VIM command:</p>
<div class="highlight"><pre><span></span>:help TangledStrings
</pre></div>


<p>Suggestions, improvements, patches, etc. are most welcome! Email me or use Launchpad to file bugs and propose merges.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/08/04/tangledstrings-10-released.html">TangledStrings 1.0 released!</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 04 August 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I'm very pleased to announce the release of 1.0 of TangledStrings, a VIM plugin to help Puppet users avoid the confusion and frustration of editing a file that Puppet is managing and subsequently losing ones changes as it is replaced by Puppet's version.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/07/29/delightful-hybridisation.html">Delightful Hybridisation</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Thu 29 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I've probably mentioned before that I really like the music of <a href="http://www.hybridsoundsystem.com/" title="Hybrid">Hybrid</a>, so I figured I'd pimp some stuff of theirs that's floated onto the web recently:</p>
<ul>
<li>A <a href="http://www.hybridsoundsystem.com/2010/07/19/glastonbury-recordings/" title="Hybrid at Glastonbury 2010">couple of videos</a> from their live set at Glastonbury this year (I'm very gutted that I didn't make it to see them)</li>
<li>Their latest Frisky Radio mixtape just hit Soundcloud, <a href="http://soundcloud.com/hybridsoundsystem/hybrid-june-2010" title="Hybrid June 2010 Frisky Radio Mix">here</a>.</li>
</ul>
<p>Enjoy!</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/07/17/dream-little-dream-of-me.html">Dream a little dream of me</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Sat 17 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>Last night I had a lovely meal out and then saw Inception with Rike and some friends.
I've really enjoyed all of Christopher Nolan's previous films and I think he does an excellent job of creating surprising and compelling stories.
I'm not really going to say anything about the plot, other than to advise you avoid reading anything about it until you've seen it - not because there's anything particularly secret, but because it's nice to not have any preconceptions about what might happen.
For me, the best films have me leaving the cinema totally caught up in their world, my mind reeling with the possibilities of what they have explored. Inception achieved this, and I want to see it again, although preferably at home on Bluray so I can hear every word of dialogue properly - a surprising shortcoming of one of London's flagship cinemas.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/07/14/random-puppetry.html">Random puppetry</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 14 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I was talking to a colleague earlier about Puppet and its ability to install packages. I'd not really given it much thought beyond using it to install packages on classes of machines, but he mentioned one particular package which gets updated quite frequently, but is extremely low risk to update - tzdata. By setting this to "ensure =&gt; latest" rather than "ensure =&gt; present" I can forget about ever having to upgrade that package again \o/
Simple really, but it hadn't occurred to me.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/07/07/pick-letter-any-letter.html">Pick a letter, any letter</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 07 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>Earlier on my laptop suffered a slight mishap which resulted in a key popping off. I examined the mechanism and it didn't obviously go back on by itself, so I googled around a little and landed on the helpful chaps at <a href="http://www.laptopkey.com/installation_guides.php">laptopkey.com</a>. I watched the video that pertains to my exact model, figured out which bits of metal had been slightly bent and a few minutes later I had everything back in working order.
It's almost a shame I didn't need to buy anything from them in return for using their helpful video ;)</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/07/06/my-python-also-spins-webs.html">My python also spins webs</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Tue 06 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>With Terminator 0.94 released I'm turning my little brain onto an idea I have for a web service and obviously I'm sticking with python.
Clearly writing all the web gubbins by hand is mental, so I'm playing with Flask, a microframework for web apps. So far I'm really liking it, but it's taken a while to figure it and sqlalchemy out.
I'm not at all convinced that this is going to be in any way scalable, but it's a nice way to test my idea :)</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2010/07/06/who-wants-to-see-something-really-ugly.html">Who wants to see something really ugly?</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Tue 06 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I think it should be abundantly clear from my postings here that I'm not a very good programmer, and this means I give myself a lot of free rope to do some very stupid things.
I'm in constant need of debugging information and in Terminator particularly where we have lots of objects all interacting and reparenting all the time. We've had a simple dbg() method for a long time, but I was getting very bored of typing out dbg('Class::method:: Some message about %d' % foo), so I decided to see what could be done about inferring the Class and method parts of the message.
It turns out that python is very good at introspecting its own runtime, so back in January, armed with my own stupidity and some help from various folks on the Internet, I came up with the following:</p>
<div class="highlight"><pre><span></span># set this to true to enable debugging output
DEBUG = False
# set this to true to additionally list filenames in debugging
DEBUGFILES = False
# list of classes to show debugging for. empty list means show all classes
DEBUGCLASSES = []
# list of methods to show debugging for. empty list means show all methods
DEBUGMETHODS = []

def dbg(log = &quot;&quot;):
    &quot;&quot;&quot;Print a message if debugging is enabled&quot;&quot;&quot;
    if DEBUG:
        stackitem = inspect.stack()[1]
        parent_frame = stackitem[0]
        method = parent_frame.f_code.co_name
        names, varargs, keywords, local_vars = inspect.getargvalues(parent_frame)
        try:
            self_name = names[0]
            classname = local_vars[self_name].__class__.__name__
        except IndexError:
            classname = &quot;noclass&quot;
        if DEBUGFILES:
            line = stackitem[2]
            filename = parent_frame.f_code.co_filename
            extra = &quot; (%s:%s)&quot; % (filename, line)
        else:
            extra = &quot;&quot;
        if DEBUGCLASSES != [] and classname not in DEBUGCLASSES:
            return
        if DEBUGMETHODS != [] and method not in DEBUGMETHODS:
            return
        try:
            print &gt;&gt; sys.stderr, &quot;%s::%s: %s%s&quot; % (classname, method, log, extra)
        except IOError:
            pass
</pre></div>


<p>How's about that for shockingly bad? ;)
It also adds a really impressive amount of overhead to the execution time.
I added the DEBUGCLASSES and DEBUGMETHODS lists so I could cut down on the huge amount of output - these are hooked up to command line options, so you can do something like "terminator -d --debug-classes=Terminal" and only receive debugging messages from the Terminal module.
I'm not exactly sure what I hope to gain from this post, other than ridicule on the Internet, but maybe, just maybe, someone will pop up and point out how stupid I am in a way that turns this into a 2 line, low-overhead function :D</p>
  </div>
</article>

<div class="pagination">
    <ul>
        <li class="pagination__prev">
            <a href="../author/chris-jones5.html">&laquo;</a>
        </li>



          <li>
            <a  href="../author/chris-jones.html">1</a>
          </li>


                <li>.....</li>
            </li>


          <li>
            <a  href="../author/chris-jones3.html">3</a>
          </li>


          <li>
            <a  href="../author/chris-jones4.html">4</a>
          </li>


          <li>
            <a  href="../author/chris-jones5.html">5</a>
          </li>


          <li>
            <a class="pagination__page--current" href="../author/chris-jones6.html">6</a>
          </li>


          <li>
            <a  href="../author/chris-jones7.html">7</a>
          </li>


          <li>
            <a  href="../author/chris-jones8.html">8</a>
          </li>


          <li>
            <a  href="../author/chris-jones9.html">9</a>
          </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


          <li>
            <a  href="../author/chris-jones23.html">23</a>
          </li>

        <li class="pagination__next">
            <a href="../author/chris-jones7.html">&raquo;</a>
        </li>
    </ul>
</div>

  </main>
    <footer>
      <section class="author">
        <div class="author__link">
          <ul>
            <li>
              <a href="https://twitter.com/cmsj" target="_blank" title="twitter">
                <i class="fab fa-twitter-square"></i>
              </a>
            </li>
            <li>
              <a href="https://github.com/cmsj" target="_blank" title="github">
                <i class="fab fa-github-square"></i>
              </a>
            </li>
            <li>
              <a href="http://cmsj.net/feeds/all.atom.xml" target="_blank" title="Feed">
                <i class="fas fa-rss-square"></i>
              </a>
            </li>
          </ul>
        </div>
      </section>
      <div class="ending-message">
        <p>&copy; Chris Jones.</p>
      </div>
    </footer>
</body>
</html>