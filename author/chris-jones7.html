<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="http://cmsj.net/theme/css/style.less">
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->


  <link rel="icon" type="image/vnd.microsoft.icon" href="http://cmsj.net/">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto+Mono">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/fontawesome-all.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/hatena-bookmark-icon.css">

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chris Jones">
  <meta name="description" content="Posts and writings by Chris Jones">
  <meta name="og:site_name" content="cmsj.net">

  <!-- Twitter Card -->




  <link href="http://cmsj.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cmsj.net Atom" />


  <title>
    cmsj.net
&ndash; Posts by: Chris Jones  </title></head>

<body>
  <main>
    <header>
      <div class="site-name">
        <a href="http://cmsj.net">cmsj.net</a>
      </div>
      <p>
        <a href="http://cmsj.net/archives.html"><i class="fas fa-archive"></i> Archive</a>
&gt; Author: Chris Jones
      </p>
    </header>

<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/07/14/random-puppetry.html">Random puppetry</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Wed 14 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I was talking to a colleague earlier about Puppet and its ability to install packages. I'd not really given it much thought beyond using it to install packages on classes of machines, but he mentioned one particular package which gets updated quite frequently, but is extremely low risk to update - tzdata. By setting this to "ensure =&gt; latest" rather than "ensure =&gt; present" I can forget about ever having to upgrade that package again \o/
Simple really, but it hadn't occurred to me.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/07/07/pick-letter-any-letter.html">Pick a letter, any letter</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Wed 07 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>Earlier on my laptop suffered a slight mishap which resulted in a key popping off. I examined the mechanism and it didn't obviously go back on by itself, so I googled around a little and landed on the helpful chaps at <a href="http://www.laptopkey.com/installation_guides.php">laptopkey.com</a>. I watched the video that pertains to my exact model, figured out which bits of metal had been slightly bent and a few minutes later I had everything back in working order.
It's almost a shame I didn't need to buy anything from them in return for using their helpful video ;)</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/07/06/my-python-also-spins-webs.html">My python also spins webs</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Tue 06 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>With Terminator 0.94 released I'm turning my little brain onto an idea I have for a web service and obviously I'm sticking with python.
Clearly writing all the web gubbins by hand is mental, so I'm playing with Flask, a microframework for web apps. So far I'm really liking it, but it's taken a while to figure it and sqlalchemy out.
I'm not at all convinced that this is going to be in any way scalable, but it's a nice way to test my idea :)</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/07/06/who-wants-to-see-something-really-ugly.html">Who wants to see something really ugly?</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Tue 06 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>I think it should be abundantly clear from my postings here that I'm not a very good programmer, and this means I give myself a lot of free rope to do some very stupid things.
I'm in constant need of debugging information and in Terminator particularly where we have lots of objects all interacting and reparenting all the time. We've had a simple dbg() method for a long time, but I was getting very bored of typing out dbg('Class::method:: Some message about %d' % foo), so I decided to see what could be done about inferring the Class and method parts of the message.
It turns out that python is very good at introspecting its own runtime, so back in January, armed with my own stupidity and some help from various folks on the Internet, I came up with the following:</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="k">output</span>
<span class="n">DEBUG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>
<span class="err">#</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">additionally</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">filenames</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">debugging</span>
<span class="n">DEBUGFILES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>
<span class="err">#</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">classes</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="k">for</span><span class="p">.</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">classes</span>
<span class="n">DEBUGCLASSES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>
<span class="err">#</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">methods</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="k">for</span><span class="p">.</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">methods</span>
<span class="n">DEBUGMETHODS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>

<span class="n">def</span><span class="w"> </span><span class="n">dbg</span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Print a message if debugging is enabled&quot;&quot;&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nl">DEBUG</span><span class="p">:</span>
<span class="w">        </span><span class="n">stackitem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inspect</span><span class="p">.</span><span class="n">stack</span><span class="p">()</span><span class="o">[</span><span class="n">1</span><span class="o">]</span>
<span class="w">        </span><span class="n">parent_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stackitem</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>
<span class="w">        </span><span class="k">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_frame</span><span class="p">.</span><span class="n">f_code</span><span class="p">.</span><span class="n">co_name</span>
<span class="w">        </span><span class="k">names</span><span class="p">,</span><span class="w"> </span><span class="n">varargs</span><span class="p">,</span><span class="w"> </span><span class="n">keywords</span><span class="p">,</span><span class="w"> </span><span class="n">local_vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inspect</span><span class="p">.</span><span class="n">getargvalues</span><span class="p">(</span><span class="n">parent_frame</span><span class="p">)</span>
<span class="w">        </span><span class="k">try</span><span class="err">:</span>
<span class="w">            </span><span class="n">self_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">names</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>
<span class="w">            </span><span class="n">classname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_vars</span><span class="o">[</span><span class="n">self_name</span><span class="o">]</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span>
<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="nl">IndexError</span><span class="p">:</span>
<span class="w">            </span><span class="n">classname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;noclass&quot;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">DEBUGFILES</span><span class="p">:</span>
<span class="w">            </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stackitem</span><span class="o">[</span><span class="n">2</span><span class="o">]</span>
<span class="w">            </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_frame</span><span class="p">.</span><span class="n">f_code</span><span class="p">.</span><span class="n">co_filename</span>
<span class="w">            </span><span class="n">extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot; (%s:%s)&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span>
<span class="w">            </span><span class="n">extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;&quot;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">DEBUGCLASSES</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="err">[]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">classname</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">DEBUGCLASSES</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">DEBUGMETHODS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="err">[]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">DEBUGMETHODS</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="k">try</span><span class="err">:</span>
<span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;%s::%s: %s%s&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="n">classname</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="p">,</span><span class="w"> </span><span class="nf">log</span><span class="p">,</span><span class="w"> </span><span class="n">extra</span><span class="p">)</span>
<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="nl">IOError</span><span class="p">:</span>
<span class="w">            </span><span class="n">pass</span>
</code></pre></div>

<p>How's about that for shockingly bad? ;)
It also adds a really impressive amount of overhead to the execution time.
I added the DEBUGCLASSES and DEBUGMETHODS lists so I could cut down on the huge amount of output - these are hooked up to command line options, so you can do something like "terminator -d --debug-classes=Terminal" and only receive debugging messages from the Terminal module.
I'm not exactly sure what I hope to gain from this post, other than ridicule on the Internet, but maybe, just maybe, someone will pop up and point out how stupid I am in a way that turns this into a 2 line, low-overhead function :D</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/07/04/good-day-2.html">A good day</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Sun 04 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>Today has been about creating, not consuming. Apart from half-watching Primal Fear with Rike, I have spent the day fixing bugs in Terminator and playing with the Akai Synthstation app on my iPad. I suspect I'm not going to be ruling the clubs anytime soon, and the UI is pretty dreadful for composing music, but it has a good library of sounds and synth mangling knobs :)
I even filmed myself playing some of the parts and edited them together into a little music video, but it's really very poor ;)
Rike's going to be out for most of tomorrow, so I have to decide between doing more of what I've been doing today, playing PS3 games or going out myself. Tricky!</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/07/04/terminator-094-released.html">Terminator 0.94 released!</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Sun 04 July 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>Lots of bug fixes and some improvements to the preferences are in this release, as well as a couple of new plugins for watching terminals for activity, or taking screenshots of individual terminals.
See the changelog for full details.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/06/08/lawnmower-man.html">The Lawnmower Man</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Tue 08 June 2010</p>
    </p>
  </div>
  <div class="article__text">
    <h1>Introduction</h1>
<p>This website shares a server with various other network services that form the foundation of my online life (i.e. IRC and Email) and I've been running into capacity issues in the last few months, so I'm running an experiment whereby I upgrade to brand new hardware (Quad Core i7, 8GB of RAM) and partition the available resources across virtual machines so the various network services are isolated into logical security zones.</p>
<h1>Whining</h1>
<p>I have plenty of experience using Xen for this sort of thing, but that's becoming more and more irrelevant in newer kernels/distributions. As much as I think that's a shame and a stupid upstream decision, I can't change it, so I need to move on to KVM and libvirt.</p>
<h1>Resolution</h1>
<p>So, with the beefy new server booted up in a -server kernel and a big, empty LVM Volume Group I got to work creating some virtual machines. This post is mainly a reminder to myself of the things I need to do for each VM :)</p>
<h1>Action</h1>
<p>These are the steps I used to make a VM with 1GB of RAM, 10GB / and 1GB of swap:</p>
<h3>Create an LVM Logical Volume</h3>
<div class="highlight"><pre><span></span><code>lvcreate -L11G -n somehostname VolumeGroup
</code></pre></div>

<h3>Create a VM image and libvirt XML definition</h3>
<div class="highlight"><pre><span></span><code>ubuntu-vm-builder kvm lucid --arch amd64 --mem=1024 --cpus=1 \
--raw=/dev/VolumeGroup/somehostname --rootsize=10240 --swapsize=1024 \
--kernel-flavour=server --hostname=somehostname \
--mirror=http://archive.ubuntu.com/ubuntu/ --components=main,universe \
--name &#39;Chris Jones&#39; --user cmsj --pass &#39;ubuntu&#39; --bridge virbr0 \
--libvirt qemu:///system --addpkg vim --addpkg ssh --addpkg ubuntu-minimal
</code></pre></div>

<p>Catchy command, huh? ;)</p>
<h3>Wait</h3>
<p>(building the VM will take a few minutes)</p>
<h3>Modify the libvirt XML definition for performance</h3>
<p>The best driver for disk/networking is the paravirtualised "virtio" driver. I found that ubuntu-vm-builder had already configured the networking to use this, but not the disk, so I modified the disk section to look like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;disk</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;block&#39;</span><span class="w"> </span><span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;source</span><span class="w"> </span><span class="na">dev=</span><span class="s">&#39;/dev/VolumeGroup/somehostname&#39;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;target</span><span class="w"> </span><span class="na">dev=</span><span class="s">&#39;vda&#39;</span><span class="w"> </span><span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
</code></pre></div>

<h3>Modify the libvirt XML definition for emulated serial console</h3>
<p>I don't really want to use VNC to talk to the console of my VMs, so I add the following to the &lt;devices&gt; section of the XML definition to make a virtualised serial port and consider it a console:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">&lt;serial</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;target</span><span class="w"> </span><span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/serial&gt;</span>
<span class="w">    </span><span class="nt">&lt;console</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;target</span><span class="w"> </span><span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/console&gt;</span>
</code></pre></div>

<h3>Modify the libvirt XML definition for a better CPU</h3>
<p>I'm running this on an Intel Core i7 (Nehalem), but libvirt's newest defined CPU type is a Core2Duo, so we'll go with that in the root of the &lt;domain&gt; section:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;cpu</span><span class="w"> </span><span class="na">match=</span><span class="s">&#39;minimum&#39;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;model&gt;</span>core2duo<span class="nt">&lt;/model&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div>

<h3>Import the XML definition into the running libvirt daemon</h3>
<div class="highlight"><pre><span></span><code><span class="n">virsh define /etc/libvirt/qemu/somehostname.xml</span>
</code></pre></div>

<h3>Mount the VM's root filesystem</h3>
<p>The Logical Volume we created should be considered as a whole disk, not a mountable partition, but dmsetup can present the partitions within it, and these should still be present after running ubuntu-vm-builder:</p>
<div class="highlight"><pre><span></span><code>mkdir /mnt/tmpvmroot
mount /dev/mapper/VolumeGroup-somehostnamep1 /mnt/tmpvmroot
</code></pre></div>

<h3>Fix fstab in the VM</h3>
<p>Edit /mnt/tmpvmroot/etc/fstab and s/hda/vda/</p>
<h3>Configure serial console in the VM</h3>
<p>Edit ﻿/etc/init/ttyS0.conf and place the following in it:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span>#<span class="w"> </span><span class="nv">ttyS0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">getty</span>
<span class="w">    </span>#
<span class="w">    </span>#<span class="w"> </span><span class="nv">This</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">maintains</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">getty</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">ttyS0</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">point</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">system</span><span class="w"> </span><span class="nv">is</span>
<span class="w">    </span>#<span class="w"> </span><span class="nv">started</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">shut</span><span class="w"> </span><span class="nv">down</span><span class="w"> </span><span class="nv">again</span>.
<span class="w">    </span><span class="nv">start</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">stopped</span><span class="w"> </span><span class="nv">rc</span><span class="w"> </span><span class="nv">RUNLEVEL</span><span class="o">=</span>[<span class="mi">2345</span>]
<span class="w">    </span><span class="nv">stop</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">runlevel</span><span class="w"> </span>[<span class="o">!</span><span class="mi">2345</span>]
<span class="w">    </span><span class="nv">respawn</span>
<span class="w">    </span><span class="k">exec</span><span class="w"> </span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">getty</span><span class="w"> </span><span class="o">-</span><span class="nv">L</span><span class="w"> </span><span class="mi">115200</span><span class="w"> </span><span class="nv">ttyS0</span><span class="w"> </span><span class="nv">xterm</span>
</code></pre></div>

<p>Edit /boot/grub/menu.lst and look for the commented "defoptions" line. Change it to:</p>
<div class="highlight"><pre><span></span><code>    # defoptions=console=ttyS0 console=tty0
</code></pre></div>

<p>(the default "quiet splash" is not useful for servers IMHO)</p>
<h3>Unmount the VM's root filesystem</h3>
<div class="highlight"><pre><span></span><code>umount /mnt/tmpvmroot
rmdir /mnt/tmpvmroot
</code></pre></div>

<h3>Start the VM</h3>
<div class="highlight"><pre><span></span><code>virsh start somehostname
</code></pre></div>

<h3>SSH into the VM</h3>
<p>I didn't specify any networking details to ubuntu-vm-builder, so the machine will boot and try to get an address from DHCP. By default you'll have a bridge device for libvirt called virbr0 and dnsmasq will be running, so watch syslog for the VM getting its address.</p>
<div class="highlight"><pre><span></span><code><span class="n">ssh</span><span class="w"> </span><span class="n">cmsj</span><span class="mf">@192.168.122</span><span class="p">.</span><span class="n">xyz</span>
</code></pre></div>

<p>you should now be in your VM! Now all you need to do is configure it to do things and then fix its networking. My plan is to switch the VMs to static IPs and then use NAT to forward connections from public IPs to the VMs, but you could bridge them onto the host's main ethernet device and assign public IPs directly to the VMs.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/06/03/python-decisions.html">Python decisions</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Thu 03 June 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>Every time I find myself hacking on some Python I find myself second guessing all sorts of tiny design decisions and so I figure the only way to get any kind of perspective on them is to talk about them. Either I'll achieve more clarity through constructing explanations of what I was thinking, or people will comment with useful insights. Hopefully the latter, but this is hardly the most popular blog in the world ;)
So. What shall we look at first. Well, I just hacked up a tiny script last night to answer a simple question:</p>
<p><em>Is most of my music collection from the 90s?</em></p>
<p>Obviously what I want to do here is examine the ID3 tags of the files in my music collection and see how they're distributed. A quick search with apt showed that Ubuntu 10.04 has two python libraries for dealing with ID3 tags and a quick play with each suggested that the one with the API most relevant to my interests was <a href="apt:python-eyed3" title="Install eyeD3">eyeD3</a>. After a few test iterations of the script I was getting bored of waiting for it to silently scan the roughly 4000 MP3s I have, so I did another quick search and found a <a href="apt:python-progressbar" title="Install progressbar">progress bar</a>library.
So that's all of the motive and opportunity established, now let's examine the means to the end. If you want to follow along at home, the whole script is <a href="/wp-content/uploads/2010/06/musicdecades.py_.txt" title="musicdecades.py.txt">here</a>.</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">eyeD3</span>
  <span class="kn">import</span> <span class="nn">progressbar</span> <span class="k">as</span> <span class="nn">pbar</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You should make sure python-eyed3 and python-progressbar are installed&quot;</span><span class="p">)</span>
 <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>First off this is the section where I'm importing the two non-default python libraries that I depend on. I want to provide a good experience when they're not installed, so I catch the exception and tell people the Debian/Ubuntu package names they need, and exit gracefully. I rename the progressbar module as I import it just because "progressbar" is annoyingly long as a name, and I don't like doing "from foo import *".
Skipping further on, we find the code that extracts the ID3 year tag:</p>
<div class="highlight"><pre><span></span><code><span class="n">year</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">getYear</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;Unknown&#39;</span>
</code></pre></div>

<p>This is something I'm really not sure about the "correctness" of; One of the reasons I went with the eyeD3 library was that the getYear() method returns None if it can't find any data, but I don't really want to capture the result, then test the result explicitly and if it's None set the value to "Unknown", so I went with the above code which only needs a single line and is (IMHO) highly readable.
This is ultimately the crux of the entire program - we've now collected the year, so we can work out which decade it's from:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
 <span class="n">year</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">0s&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
</code></pre></div>

<p>If this isn't an unknown year we chop the final digit off the year and replace it with a zero. Job done!
Next up, another style question. Rather than store the year we just processed I want to know how many of each decade have been found, so the obvious choice is a dict where the keys are the decades and the values are the number of times each decade has been found. One option would be to pre-fill the dict with all the decades, each with a value of zero, but that seems redundant and ugly, so instead I start out with an empty dict. This presents a challenge - if we find a decade that isn't already a key in the dict (which will frequently be the case) we need to notice that and add it. We could do this by pre-emptively testing the dict with its has_key() method, but that struck me as annoyingly wordy, so I went with:</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
  <span class="n">years</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
  <span class="n">years</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>

<p>If we are incrementing a year that isn't already in the dict, python will raise a KeyError, at which point we know what's happened and know the correct value is 1, so we just set it explicitly. Seems like the simplest solution, but is it the sanest?
The only other thing I wanted to say is a complaint - having built up the dict I then want to print it nicely, so I have a quick list comprehension to produce a list of strings of the format "19xx: yy" (i.e. the decade and the final number of tracks found for that decade), which I then join together using:</p>
<div class="highlight"><pre><span></span><code><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">)</span>
</code></pre></div>

<p>which I hate! Why can't I do:</p>
<div class="highlight"><pre><span></span><code><span class="n">OUTPUT</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
</code></pre></div>

<p>(where "OUTPUT" is the list of strings). If that were possible, what I'd actually do is tack the .join() onto the end of the list comprehension and a single line would turn the dict into a printable string.
So there we have it, my thoughts on the structure of my script. I'd also add that I've become mildly obsessive about getting good scores from pylint on my code, which is why it's rigorously formatted, docstring-ed and why the variable names in the __main__ section are in capitals.
What are your thoughts?
Oh, and the answer is no, most of my music is from the 2000s. The 1990s come in second :)</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/05/13/gtk-icon-cache-search-tool.html">gtk icon cache search tool</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Thu 13 May 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>Earlier on this evening I was asking the very excellent Ted Gould about a weird problem with my Gtk+ icon theme - an app I'd previously installed by hand in /usr/local/, but subsequently removed, had broken icons because Gtk+ was looking in /usr/local/share/icons/ instead of /usr/share/icons/.
We did a little digging and realised I had an icon theme cache file in /usr/local/ that was overriding the one in /usr/. A bit of deleting later and it's back, but in the process we whipped up a little bit of python to print out the filename of an icon given an icon name.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python</span>
<span class="c1"># gtk-find-icon by Chris Jones &lt;cmsj@tenshu.net&gt;</span>
<span class="c1"># Copyright 2010. GPL v2.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">gtk</span>

<span class="n">THEME</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">IconTheme</span><span class="p">()</span>
<span class="n">ICON</span> <span class="o">=</span> <span class="n">THEME</span><span class="o">.</span><span class="n">lookup_icon</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
 <span class="n">gtk</span><span class="o">.</span><span class="n">ICON_SIZE_MENU</span><span class="p">,</span>
 <span class="n">gtk</span><span class="o">.</span><span class="n">ICON_LOOKUP_USE_BUILTIN</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">ICON</span><span class="p">:</span>
 <span class="nb">print</span> <span class="s2">&quot;None found&quot;</span>
<span class="k">else</span><span class="p">:</span>
 <span class="nb">print</span><span class="p">(</span><span class="n">ICON</span><span class="o">.</span><span class="n">get_filename</span><span class="p">())</span>
</code></pre></div>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2010/04/19/hybrid-disappear-here.html">Hybrid - Disappear Here</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Mon 19 April 2010</p>
    </p>
  </div>
  <div class="article__text">
    <p>It's a while since I wrote anything in the Music category of this blog, and since everything has been about my software projects recently, I figure it's time to mix things up a little. It's also just a few weeks since the release of the latest studio album by probably my favourite band of the last few years, <a href="http://www.hybridsoundsystem.com/" title="Hybrid">Hybrid</a>.
The album is called Disappear Here and it's pretty damn good - I was going to describe the tracks individually, but that's what reviewers typically do and it always sounds insufferably poncy, so I suggest you just go to the <a href="http://www.disappearhere.info" title="Disappear Here">album's site</a> and listen to the damn thing yourself ;)
They also post semi-frequent hour long DJ mixes on their <a href="http://soundcloud.com/hybridsoundsystem">Soundcloud page</a>, which I would recommend!</p>
  </div>
</article>

<div class="pagination">
    <ul>
        <li class="pagination__prev">
            <a href="http://cmsj.net/author/chris-jones6.html">&laquo;</a>
        </li>



          <li>
            <a  href="http://cmsj.net/author/chris-jones.html">1</a>
          </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones4.html">4</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones5.html">5</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones6.html">6</a>
          </li>


          <li>
            <a class="pagination__page--current" href="http://cmsj.net/author/chris-jones7.html">7</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones8.html">8</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones9.html">9</a>
          </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones10.html">10</a>
          </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


          <li>
            <a  href="http://cmsj.net/author/chris-jones23.html">23</a>
          </li>

        <li class="pagination__next">
            <a href="http://cmsj.net/author/chris-jones8.html">&raquo;</a>
        </li>
    </ul>
</div>

  </main>
    <footer>
      <div class="author__logo">
          <img src="http://cmsj.net/theme/images/logo.png" alt="logo">
      </div>
      <section class="author">
        <div class="author__name">
          <a href="http://cmsj.net/pages/about.html">Chris Jones</a>
          <p></p>
        </div>
        <div class="author__link">
          <ul>
            <li>
              <a href="https://twitter.com/cmsj" target="_blank" title="twitter">
                <i class="fab fa-twitter-square"></i>
              </a>
            </li>
            <li>
              <a href="https://github.com/cmsj" target="_blank" title="github">
                <i class="fab fa-github-square"></i>
              </a>
            </li>
            <li>
              <a href="http://cmsj.net/feeds/all.atom.xml" target="_blank" title="Feed">
                <i class="fas fa-rss-square"></i>
              </a>
            </li>
          </ul>
        </div>
      </section>
      <div class="ending-message">
        <p>&copy; Chris Jones. Powered by <a href="http://getpelican.com" target="_blank">Pelican</a>, Theme is using <a href="https://github.com/laughk/pelican-hss" target="_blank">HSS</a>. </p>
      </div>
    </footer>
</body>
</html>