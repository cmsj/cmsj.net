<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="http://cmsj.net/theme/css/style.less">
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->


  <link rel="icon" type="image/vnd.microsoft.icon" href="http://cmsj.net/">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto+Mono">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/fontawesome-all.min.css">
  <link rel="stylesheet" type="text/css" href="http://cmsj.net/theme/css/hatena-bookmark-icon.css">

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chris Jones">
  <meta name="description" content="Posts and writings by Chris Jones">
  <meta name="og:site_name" content="cmsj.net">

  <!-- Twitter Card -->



<link href="http://cmsj.net/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="cmsj.net misc Category Atom" />

  <link href="http://cmsj.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cmsj.net Atom" />


  <title>
    cmsj.net
&ndash; Category: misc  </title></head>

<body>
  <main>
    <header>
      <div class="site-name">
        <a href="http://cmsj.net">cmsj.net</a>
      </div>
      <p>
        <a href="http://cmsj.net/archives.html"><i class="fas fa-archive"></i> Archive</a>
&gt; Category: misc
&brvbar; <a href="http://cmsj.net/feeds/{slug}.atom.xml">Atom</a>
      </p>
    </header>

<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2023/09/06/haosscryptednvr.html">Mounting a separate partition for Scrypted NVR storage in Home Assistant OS</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Wed 06 September 2023</p>
    </p>
  </div>
  <div class="article__text">
    <p>All of my smart home stuff is running in Home Assistant, and I'm using their OS on a Mini PC.</p>
<p>One of the things I'm running on that OS is the Scrypted Add-On to bridge my generic RTSP cameras into HomeKit, and to use Scrypted's NVR.</p>
<p>By default, Scrypted will be storing NVR recordings in HassOS' <code>data</code> partition. I wanted to make sure that even if the NVR goes wild and fills the disk, the rest of my Home Assistant system wouldn't have to deal with running out of disk space, so I started looking for a way to configure HassOS and/or Scrypted to store the NVR recordings elsewhere. Turns out that isn't directly possible, but there is a very useful feature of HassOS that makes it possible.</p>
<p>Specifically, that feature is that you can import <code>udev</code> rules. With that I can ensure that a dedicated partition can be mounted in the location that the NVR recordings will be written, and now even if Scrypted goes haywire and runs that partition out of space, the rest of the system will function normally.</p>
<p>The official documentation for how to import <code>udev</code> rules (amongst many other useful things) is <a href="https://github.com/home-assistant/operating-system/blob/dev/Documentation/configuration.md">here</a>, but the approximate set of steps is:</p>
<ul>
<li>Arrange for there to be a partition available on your Home Assistant OS machine, formatted as <code>ext4</code>, with the label <code>NVR</code>. I put a second disk in, so it's completely separate from the boot disk which Home Assistant OS may choose to modify later.</li>
<li>Format a USB stick as FAT32, named <code>CONFIG</code></li>
<li>Create a directory on that stick with the name <code>udev</code></li>
<li>In that <code>udev</code> folder create a plain text file called <code>80-mount-scrypted-nvr-volume.rules</code></li>
<li>Place the udev rules below in that file</li>
<li>Put the USB stick in your Home Assistant OS machine and, from a terminal, run <code>ha os import</code></li>
</ul>
<p>The contents of that rules file should be:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This will mount a partition with the label &quot;NVR&quot; to: /mnt/data/supervisor/addons/data/09e60fb6_scrypted/scrypted_nvr/</span>

<span class="c1"># Import partition info into environment variables</span>
<span class="n">IMPORT</span><span class="p">{</span><span class="n">program</span><span class="p">}</span><span class="o">=</span><span class="s2">&quot;/usr/sbin/blkid -o udev -p %N&quot;</span>

<span class="c1"># Exit if the partition is not a filesystem</span>
<span class="n">ENV</span><span class="p">{</span><span class="n">ID_FS_USAGE</span><span class="p">}</span><span class="o">!=</span><span class="s2">&quot;filesystem&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GOTO</span><span class="o">=</span><span class="s2">&quot;abort_rule&quot;</span>

<span class="c1"># Exit if the partition isn&#39;t for NVR data</span>
<span class="n">ENV</span><span class="p">{</span><span class="n">ID_FS_LABEL</span><span class="p">}</span><span class="o">!=</span><span class="s2">&quot;NVR&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GOTO</span><span class="o">=</span><span class="s2">&quot;abort_rule&quot;</span>

<span class="c1"># Store the mountpoint</span>
<span class="n">ENV</span><span class="p">{</span><span class="n">mount_point</span><span class="p">}</span><span class="o">=</span><span class="s2">&quot;/mnt/data/supervisor/addons/data/09e60fb6_scrypted/scrypted_nvr/&quot;</span>

<span class="c1"># Mount the device on &#39;add&#39; action (e.g. it was just connected to USB)</span>
<span class="n">ACTION</span><span class="o">==</span><span class="s2">&quot;add&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RUN</span><span class="p">{</span><span class="n">program</span><span class="p">}</span><span class="o">+=</span><span class="s2">&quot;/usr/bin/mkdir -p </span><span class="si">%E</span><span class="s2">{mount_point}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RUN</span><span class="p">{</span><span class="n">program</span><span class="p">}</span><span class="o">+=</span><span class="s2">&quot;/usr/bin/systemd-mount --no-block --automount=no --collect $devnode </span><span class="si">%E</span><span class="s2">{mount_point}&quot;</span>

<span class="c1"># Umount the device on &#39;remove&#39; action (a.k.a unplug or eject the USB drive)</span>
<span class="n">ACTION</span><span class="o">==</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ENV</span><span class="p">{</span><span class="n">dir_name</span><span class="p">}</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RUN</span><span class="p">{</span><span class="n">program</span><span class="p">}</span><span class="o">+=</span><span class="s2">&quot;/usr/bin/systemd-umount </span><span class="si">%E</span><span class="s2">{mount_point}&quot;</span>

<span class="c1"># Exit</span>
<span class="n">LABEL</span><span class="o">=</span><span class="s2">&quot;abort_rule&quot;</span>
</code></pre></div>

<p>Notes:</p>
<ul>
<li>As far as I know, the mountpoint for the Scrypted add-on should be stable, but I can't promise this.</li>
<li>This should be very safe as it will ignore any partition that isn't labelled <code>NVR</code>.</li>
<li>This should work with removable disks (e.g. USB), however, the Scrypted addon will not be stopped if you unplug the disk, so I would strongly recommend not doing that without stopping Scrypted first.</li>
</ul>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2023/08/19/tailscaledocker.html">Running Tailscale in Docker</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Sat 19 August 2023</p>
    </p>
  </div>
  <div class="article__text">
    <p>I run most of my home services in Docker, and I decided it was time to migrate Tailscale from the host into Docker too.</p>
<p>This turned out to be an interesting journey, but I figured I'd talk about it here for anyone else hitting the same issues.</p>
<p>Here is my resulting Docker compose yaml:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">tailscale</span><span class="p">:</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tailscale</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tailscale/tailscale:latest</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;host&quot;</span><span class="w"> </span><span class="c1"># Easy mode</span>
<span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># I&#39;m only about 80% sure this is required</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/srv/ssdtank/docker/tailscale/data:/var/lib</span><span class="w"> </span><span class="c1"># tailscale/tailscale.state in here is where our authkey lives</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/net/tun:/dev/net/tun</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket</span><span class="w"> </span><span class="c1"># This seems kinda terrible, but the daemon complains a lot if it can&#39;t connect to this</span>
<span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span><span class="w"> </span><span class="c1"># Required</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_ADMIN</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_RAW</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">TS_HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lolserver&quot;</span>
<span class="w">      </span><span class="nt">TS_STATE_DIR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/lib/tailscale&quot;</span><span class="w"> </span><span class="c1"># This gives us a persistent entry in TS Machines, rather than Epehmeral</span>
<span class="w">      </span><span class="nt">TS_USERSPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># Bizarrely, even if you bind /dev/net/tun in, you still need to tell the image to not use userspace networking</span>
<span class="w">      </span><span class="nt">TS_AUTH_ONCE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># If you have a config error somewhere, and this is set to true, it&#39;ll be really hard to figure it out</span>
<span class="w">      </span><span class="nt">TS_ACCEPT_DNS</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># I don&#39;t want TS pushing any DNS to me.</span>
<span class="w">      </span><span class="nt">TS_ROUTES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.88.0/24,10.0.91.0/24&quot;</span><span class="w"> </span><span class="c1"># Docs say this is for accepting routes. Code says it&#39;s for advertising routes. Awesome.</span>
<span class="w">      </span><span class="nt">TS_EXTRA_ARGS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;--advertise-exit-node&quot;</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">com.centurylinklabs.watchtower.enable</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</code></pre></div>

<p>Important things to note are:</p>
<ul>
<li><code>TS_STATE_DIR</code> is useful if you want a persistent node rather than an Ephemeral one (I'm not running this as part of some app deployment, this is LAN infrastructure)</li>
<li><code>TS_USERSPACE</code> shouldn't just always default to <code>true</code>, it should check if <code>/dev/net/tun</code> is available, but it doesn't, so you have to force it to <code>false</code> if you want kernel networking.</li>
<li><code>TS_AUTH_ONCE</code> is great, but if you have an error in the lower level networking setup, having this set to <code>true</code> will hide it on restarts of the container. I suggest keeping this <code>false</code>.</li>
<li><code>TS_ROUTES</code> is currently wrong in the documentation. It is described as being for <em>accepting</em> routes <em>from</em> other hosts, but it's actually for <em>advertising</em> routes <em>to</em> other hosts.</li>
</ul>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2021/04/12/macgithubactions.html">Lessons learned about using GitHub Actions to build macOS apps</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Mon 12 April 2021</p>
    </p>
  </div>
  <div class="article__text">
    <h2>Introduction</h2>
<p><a href="https://www.hammerspoon.org/">Hammerspoon</a> now has <a href="https://github.com/Hammerspoon/hammerspoon/actions/workflows/ci_nightly.yml">per-commit development builds</a> generated automatically by a <a href="https://github.com/features/actions">GitHub Actions</a> <a href="https://github.com/Hammerspoon/hammerspoon/blob/master/.github/workflows/ci_nightly.yml">workflow</a>.</p>
<p>This was a surprisingly slow and painful process to set up, so here are some things I learned along the way.</p>
<h2>I prefer scripts to actions</h2>
<p>There are <em>tons</em> of third party GitHub Actions available in their <a href="https://github.com/marketplace?type=actions">marketplace</a>. Almost every time I use one, I come to regret it and end up switching to just running a bash script.</p>
<h2>More useful checkouts</h2>
<p>If you want to do anything other than interact with the current code (e.g. access tag history) you'll find it fails. Add the <code>fetch-depth</code> argument to <code>actions/checkout</code>:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout foo</span>
<span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">    </span><span class="nt">with</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">fetch-depth:0</span>
</code></pre></div>

<h2>Checking out a private repo from a public one is weirdly hard</h2>
<p>Since these development builds are signed, they need access to a signing key. GitHub has a system for sharing secrets with a repo, but it's limited to 64KB values. For anything else, you need to encrypt the secrets in a repo and set a repository secret with the passphrase.</p>
<p>It seemed to me like it would be a good idea to keep the encrypted secrets in a private repository that the build process would check out, so the ciphertext is never exposed to the gaze of the Internet.</p>
<p>Unfortuantely, GitHub's <a href="https://docs.github.com/en/developers/apps/scopes-for-oauth-apps">OAuth scopes</a> only allow you to give full read/write permission to all repositories a user can access, there's no way to grant read-only access.</p>
<p>So, I decided it was safer to just try and be extra-careful about how I encrypt my secrets, and keep them in a public repository.</p>
<h2>Code signing a macOS app in CI needs a custom keychain</h2>
<p>The default login keychain requires a password to unlock, so if you put a signing certificate there, your CI builds will hang indefinitely waiting for a password to be entered into a UI dialog you can't see.</p>
<p>I took some ideas from the <a href="https://github.com/devbotsxyz/import-signing-certificate">devbotsxyz action</a> and a couple of blog posts, to come up with <a href="https://github.com/Hammerspoon/hammerspoon/blob/master/scripts/github-ci-nightly-keychain.sh">my own script</a> to create a keychain, unlock it, import the signing certificate, disable the keychain's lock timeout, and allow codesigning tools to use the keychain without a password.</p>
<h2>Xcode scrubs the inherited environment</h2>
<p>Update: This is not actually true. When I wrote this item, I had forgotten that our build system included a Makefile and it's <em>make</em> not Xcode that was scrubbing the environment.</p>
<p>Normally, you can use environment variables like <code>$GITHUB_ACTIONS</code> to determine if you're running in a CI-style situation. I use this for our test framework to <a href="https://github.com/Hammerspoon/hammerspoon/blob/master/Hammerspoon%20Tests/HSTestCase.m#L94">detect CI</a> so certain tests can be skipped.</p>
<p>Unfortunately, it seems like <code>xcodebuild</code> scrubs the environment when running script build phases, so instead I created an empty file on disk that the build scripts could check for:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Workaround xcodebuild scrubbing environment</span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">touch ../is_github_actions</span>
</code></pre></div>

<p>This allows us to skip things like uploading debug symbols to Sentry.</p>
<h2>You can't upload artifacts from strange paths</h2>
<p>The <code>actions/upload-artifact</code> action will refuse to upload any artifacts that have <code>../</code> or <code>./</code> in their path. I assume this is for security reasons, but that makes no sense because all you have to do is move/copy the file you want into the runner's <code>$PWD</code> and you can upload them:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prepare artifacts</span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mv ../archive/ ./</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload artifact</span>
<span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v2</span>
<span class="w">    </span><span class="nt">with</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">archive/foo</span>
</code></pre></div>

<h2>It's pretty easy to verify your code signature, Gatekeeper acceptance, entitlements and notarization status</h2>
<p>For Hammerspoon these are part of a more complex <a href="https://github.com/Hammerspoon/hammerspoon/blob/master/scripts/libbuild.sh">release script library</a>, but in essence these are the commands that you can use to either check return codes, or outputs, for whether your app is as signed/notarized/entitled as you expect it to be:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check valid code signature</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>codesign<span class="w"> </span>--verify<span class="w"> </span>--verbose<span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="s2">&quot;/path/to/Foo.app&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;FAILED: Code signature check&quot;</span>
<span class="k">fi</span>

<span class="c1"># Check valid code signing entity</span>
<span class="nv">MY_KNOWN_GOOD_ENTITY</span><span class="o">=</span><span class="s2">&quot;Authority=Developer ID Application: Jonny Appleseed (ABC123ABC)&quot;</span>
<span class="nv">ACTUAL_SIGNER</span><span class="o">=</span><span class="k">$(</span>codesign<span class="w"> </span>--display<span class="w"> </span>--verbose<span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="s2">&quot;/path/to/Foo.app&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>^Authority<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACTUAL_SIGNER</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MY_KNOWN_GOOD_ENTITY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;FAILED: Code signing authority&quot;</span>
<span class="k">fi</span>

<span class="c1"># Check Gatekeeper acceptance</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>spctl<span class="w"> </span>--verbose<span class="o">=</span><span class="m">4</span><span class="w"> </span>--assess<span class="w"> </span>--type<span class="w"> </span>execute<span class="w"> </span><span class="s2">&quot;/path/to/Foo.app&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;FAILED: Gatekeeper acceptance&quot;</span>
<span class="k">fi</span>

<span class="c1"># Check Entitlements match</span>
<span class="nv">EXPECTED</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>/path/to/source/Foo.entitlements<span class="k">)</span>
<span class="nv">ACTUAL</span><span class="o">=</span><span class="k">$(</span>codesign<span class="w"> </span>--display<span class="w"> </span>--entitlements<span class="w"> </span>:-<span class="w"> </span><span class="s2">&quot;/path/to/Foo.app&quot;</span><span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACTUAL</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">EXPECTED</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;FAILED: Entitlements&quot;</span>
<span class="k">fi</span>
</code></pre></div>

<p>I do these even on local release builds, to ensure nothing was missed before pushing out a release, but they also make sense to do in CI.</p>
<h2>That's it</h2>
<p>Not a ground-shaking set of things to learn, but combined they took several hours to figure out, so maybe this post saves someone else some time.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2021/01/12/ez3dbedmod.html">EasyThreeD X1 Heated Bed Mod</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Tue 12 January 2021</p>
    </p>
  </div>
  <div class="article__text">
    <p>(If you don't want to read this whole thing, skip to the end of the post for a tl;dr version)</p>
<p>I was lucky enough to get a <a href="https://amzn.to/3i8l8Sz">Labists X1</a> 3D printer for Christmas a few weeks ago, and it's the first 3D printer I've had or really even interacted with.</p>
<p>It's been a fascinating journey so far, learning about how to calibrate a printer, how to use slicers, and how to start making my own models.</p>
<p>Something that became obvious fairly quickly though, was that the printer would be more reliable with a heated bed. I've been able to get reliable prints via the use of rafts, but that adds time to prints and wastes filament, so I decided to see if I could mod the printer to have a heated bed.</p>
<p>I started Googling and quickly discovered that my printer is actually a rebadged <a href="https://www.easythreed.com/h-col-1223.html">EasyThreed X1</a> and that EasyThreed sell a <a href="https://www.aliexpress.com/i/4000911088465.html">hotbed accessory</a> for the X1, but it's an externally powered/controlled device. That's fine in theory, but I have quickly gotten very attached to being able to completely remotely control the printer via <a href="https://octoprint.org/">Octoprint</a>. So, the obvious next step was to try and mod the printer to be able to drive the heater directly.</p>
<p>Looking inside the controller box showed a pretty capable circuit board:</p>
<p><img alt="EasyThreed X1 controller board" src="http://cmsj.net/images/easythreed_x1_controller.jpg"></p>
<p>but it was instantly obvious that next to the power terminal for the extruder heater, was a terminal labelled <code>HOT-BED</code>:</p>
<p><img alt="Hot bed power terminal" src="http://cmsj.net/images/easythreed_x1_terminals.jpg"></p>
<p>Next on my journey of discovery was the communication info that Octoprint was sending/receiving, among which I saw:</p>
<p><code>Recv: echo:Marlin 1.1.0-RC3</code></p>
<p>which quickly led me to the <a href="https://github.com/MarlinFirmware/Marlin">Marlin</a> open source project which, crucially, is licensed as GPL. For those who don't know, GPL means that since Labists have given me a binary of Marlin in the printer, they have to give me the source code if I ask for it.</p>
<p>I reached out to Labists and they were happy to supply the source, then I also emailed EasyThreed to ask if I could have their source for the X1 as well (and while I was at it, their X3 printer, which looks a lot like the X1, but ships with a heated bed already as part of the product). They sent me the source with no real issues, so I grabbed the main Marlin repo, checked out the tag for <code>1.1.0-RC3</code> and started making branches for the various Labists/EasyThreed source trees I'd acquired. Since their changes were a bit gratuitous in places (random whitespace changes, DOS line endings, tabs, etc) I cleaned them up quite a bit to try and isolate the diffs to code/comment changes.</p>
<p>Since it's all GPL, I've republished their code with my cleanups:</p>
<ul>
<li><a href="https://github.com/cmsj/Marlin/tree/1.1.0-RC3-Labists-X1">Labists X1</a></li>
<li><a href="https://github.com/cmsj/Marlin/tree/1.1.0-RC3-EasyThreeD-X1">EasyThreed X1</a></li>
<li><a href="https://github.com/cmsj/Marlin/tree/1.1.0-RC3-EasyThreeD-X3">EasyThreed X3</a></li>
</ul>
<p>The specific diffs aren't particularly important (although the Labists firmware does have some curious changes, like disabling thermal runaway protection), but by reading up a bit on configuring Marlin, and comparing the differences between the X3 and the X1, it seemed like very little would need to change to enable the bed heater and its temperature sensor (a header for which is also conveniently present on the controller board).</p>
<p>At this point in the investigation I had:</p>
<ul>
<li>A controller board with:<ul>
<li>A power terminal for a bed heater</li>
<li>A header for a bed temperature sensor</li>
</ul>
</li>
<li>Source for the controller firmware</li>
<li>Source for an extremely similar printer that has a bed heater</li>
<li>An external bed heater with power and sensor cables</li>
</ul>
<p>Not a bad situation to be in!</p>
<p>Diving into the firmware, I found that Marlin keeps most board-specific settings in <code>Configuration.h</code> and specifically, it contains <code>#define TEMP_SENSOR_BED 0</code>. The number that <code>TEMP_SENSOR_BED</code> is defined as, indicates to Marlin what type of temp sensor is attached (with <code>0</code> obviously meaning nothing is attached). The X3 has a value of <code>1</code> (a 100k thermistor), but I found that I could only get reliable readings with it set to <code>4</code> (a 10k thermistor).</p>
<p>Believe it or not, that's actually the only thing that <em>has</em> to change, but I did also change <code>#define BED_MAXTEMP 150</code> because 150C seems kind of high. This define sets a temperature at which Marlin will shut itself down as a safety measure. As far as I can tell, 50C-70C is a more realistic range for PLA, and even with ABS it seems as though 110C is recommended. I haven't printed ABS yet and don't have any real plans to, so I reduced the safety limit to 100C.
I also modified the build version strings in <code>Default_Version.h</code> so I'd be able to quickly tell in Octoprint if I had successfully uploaded a new firmware.</p>
<p>Next came the challenge of building the firmware. I grabbed the latest Arduino IDE, but it failed to compile Marlin correctly (perhaps because I was using the macOS version of Ardino IDE). Labists helpfully included a Windows build of Arduino IDE 1.0.5 with their firmware source, which was able to build it. Arduino IDE is also GPL, but I haven't republished that yet because I haven't audited the archive for other things that I don't have rights to distribute.</p>
<p>To get the firmware to upload correctly to the X1, I had to set the board type in Arduino IDE to <code>Melzi</code> and select the COM port for its USB interface, except its USB interface wasn't showing up and Windows' Device Manager couldn't find a driver for it. Some Googling for the USB VID/PID of that device led me to the manufacturer of the CH340 chipset and <a href="http://www.wch.cn/download/ch341ser_exe.html">their drivers</a>.</p>
<p>Finally the moment of truth - was I about to destroy a controller board with a bad firmware/driver? I clicked the Upload button, waited for it to complete, attached the controller to my Octoprint machine again and.......</p>
<p><code>Recv: echo:Marlin 1.1.0-RC3-cmsj</code></p>
<p>Success! I then waited for Octoprint to start communicating with the printer and monitoring temperatures...</p>
<p><code>Recv: ok T:24.2 /0.0 B:23.6 /0.0 T0:24.2 /0.0 @:0 B@:0</code></p>
<p>For those of you who aren't familiar with Octoprint/GCode, the <code>T:24.2</code> is the temp sensor in the extruder and the <code>B23.6</code> is the reading from the bed sensor! Another success!</p>
<p>After replacing the X1's 30W power supply with a 60W variant so it could power the motors <em>and</em> the heater, I asked it to heat up to 50C, and after a little while....</p>
<p><code>Recv: ok T:28.1 /0.0 B:49.9 /50.0 T0:28.1 /0.0 @:0 B@:127</code></p>
<p>Perfect!</p>
<p>And here is the first test print I did, to make sure everything else was still working:</p>
<p><img alt="Calibration cubes" src="http://cmsj.net/images/easythreed_x1_cubes.jpg"></p>
<p>The cubes on the left are from before the heated bed, where I was having to level the bed closer to the nozzle to get enough adhesion and the cube on the right is the first print with the heated bed. I think the results speak for themselves - much better detail retention. It's not visible, but the "elephant's foot" is gone too!</p>
<p>This has been a super rewarding journey, and I'm incredibly grateful to all the people in the 3D printing community upon whose shoulders I am standing. It's a rare and beautiful thing to find a varied community of products, projects and people, all working on the same goals and producing such high quality hardware and software along the way.</p>
<h1>And now the tl;dr version</h1>
<p>If you want to do this mod to your X1, here are some things you should know, and some things you will need:</p>
<ul>
<li>I am not responsible for your printer. This is a physical and firmware mod, please be careful and think about what you're doing.</li>
<li>Buy the official <a href="https://www.aliexpress.com/i/4000911088465.html">hotbed accessory</a>, open its control box and unplug the temperature sensor cable. If for some reason you use a different hotbed, it needs to be 12V, draw no more than 30W, and your temp sensor will need to be something that Marlin can understand via the <code>TEMP_SENSOR_BED</code> define.</li>
<li>Buy a 12V 5A barrel plug power supply (I used <a href="https://amzn.to/3oM2VN3">this one</a> but there are a million options). Use this from now on to power your X1.</li>
<li>Grab the modified Marlin source from my GitHub repo:<ul>
<li>Either <a href="https://github.com/cmsj/Marlin/tree/1.1.0-RC3-EasyThreeD-X1-cmsj">EasyThreed X1</a> - see the precise changes from EasyThreed's firmware <a href="https://github.com/cmsj/Marlin/compare/1.1.0-RC3-EasyThreeD-X1...cmsj:1.1.0-RC3-EasyThreeD-X1-cmsj">here</a></li>
<li>Or <a href="https://github.com/cmsj/Marlin/tree/1.1.0-RC3-Labists-X1-cmsj">Labists X1</a> - this has <a href="https://github.com/cmsj/Marlin/compare/1.1.0-RC3-Labists-X1...cmsj:1.1.0-RC3-Labists-X1-cmsj">more changes</a> than the EasyThreed version, since I pulled back in some of Labists changes, but left thermal runaway protection enabled.</li>
</ul>
</li>
<li>Install the CH340 USB Serial drivers. There seem to be lots of places to get these from, I used <a href="http://www.wch.cn/download/ch341ser_exe.html">these</a></li>
<li>Install Arduino IDE 1.0.5 - still available from the bottom of <a href="https://www.arduino.cc/en/main/OldSoftwareReleases">this page</a></li>
<li>In Arduino IDE, open the <code>Marlin.ino</code> file from the <code>Marlin</code> directory and click the ✔ button on the toolbar, this will compile the source so you can check everything is installed correctly.</li>
<li>If you plan to print PLA, you might want to increase the <code>BED_MAXTEMP</code> define to something higher than <code>100</code>.</li>
<li>Remove the bed-levelling screws from your X1, swap the original bed for the heated one.</li>
<li>Open the controller box of your X1, plug the bed's thermal sensor into the controller board in the <code>TB1</code> header.</li>
<li>Wire the bed's power into the green <code>HOT-BED</code> terminal. For the best results you probably want to unsolder the original power cable from the bed and use something thinner and more flexible (but at the very least you need something longer).</li>
<li>Reassemble the controller box and run all the wires neatly. I recommend you manually move the bed around to make sure neither the power nor temp sensor wires snag on anything.</li>
<li>Connect the controller box's USB port to your PC, and in Arduino IDE click the ➡ button to compile and upload the firmware. Wait until it says <code>Upload complete</code>.</li>
<li>In theory, you're done! Check the temperature readings in some software that can talk to the printer (Octoprint, Pronterface, etc.), tell it to turn the bed heater on and make sure the temps rise to the level you asked for. I would definitely encourage you to do this while next to the printer, in case something goes dangerously wrong!</li>
</ul>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2019/05/20/app-creation-failed-update1.html">Update: Failing to create an app</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Mon 20 May 2019</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="/2019/04/24/app-creation-failed.html">Previously</a> I wrote about how I'd tried to create an app, but ultimately failed because I wasn't getting the results I wanted out of the macOS CoreAudio APIs.</p>
<p>Thanks to some excellent input from <a href="https://twitter.com/DavidLublin">David Lublin</a> I refactored the code to be able to switch easily between different backend audio APIs, and <a href="https://github.com/cmsj/HotMic/blob/master/HotMic/Audio%20Backends/THMBackEndAVFCapture.m">implemented a replacement</a> for CoreAudio using AVFoundation's AVCaptureSession and it seems to work!</p>
<p>I'd still like to settle back on CoreAudio at some point, but for now I can rest assured that whenever the older versions of SoundSource stop working, I still have a working option.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2019/05/20/imapsync-docker.html">Overengineered email migration</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Mon 20 May 2019</p>
    </p>
  </div>
  <div class="article__text">
    <p>I recently had the need to migrate someone in my family off an old ISP email account, onto a more modern email account, without simply shutting down the old account. The old address has been given out to people/companies for at least a decade, so it's simply not practical to stop receiving its email.</p>
<p>Initially, I used the ISP's own server-side filtering to forward emails on to the new account and then delete them, however, all of the fantabulous anti-spam technologies that are used these days, conspired to make it unreliable.</p>
<p>So instead, I decided that since I can access IMAP on both accounts, and I have a server at home running all the time, I'd just use some kind of local tool to fetch any emails that show up on the old account and move them to the new one.</p>
<p>After some investigation, I settled on <a href="https://imapsync.lamiral.info/">imapsync</a> as the most capable tool for the job. It's ultimately "just" a Perl script, but it's fantastically well maintained by Gilles Lamiral. It's Open Source, but I'm a big fan of supporting FOSS development, so I happily paid the 60€ Gilles asks for.</p>
<p>My strong preference these days is always to run my local services in Docker, and fortunately Gilles publishes an <a href="https://hub.docker.com/r/gilleslamiral/imapsync/">official imapsync Dockule</a> so I set to work in Ansible to orchestrate all of the pieces I needed to get this running.</p>
<p>The first piece was a simple bash script that calls imapsync with all of the necessary command line options:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># This is /usr/local/bin/imapsync-user-isp-fancyplace.sh</span>
/usr/bin/docker<span class="w"> </span>run<span class="w"> </span>-u<span class="w"> </span>root<span class="w"> </span>--rm<span class="w"> </span>-v/root/.imap-pass-isp.txt:/isp-pass.txt<span class="w"> </span>-v/root/.imap-pass-fancyplace.txt:/fancyplace-pass.txt<span class="w"> </span>gilleslamiral/imapsync<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>imapsync<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--host1<span class="w"> </span>imap.isp.net<span class="w"> </span>--port1<span class="w"> </span><span class="m">993</span><span class="w"> </span>--user1<span class="w"> </span>olduser@isp.net<span class="w"> </span>--passfile1<span class="w"> </span>/isp-pass.txt<span class="w"> </span>--ssl1<span class="w"> </span>--sslargs1<span class="w"> </span><span class="nv">SSL_verify_mode</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--host2<span class="w"> </span>imap.fancyplace.com<span class="w"> </span>--port2<span class="w"> </span><span class="m">993</span><span class="w"> </span>--user2<span class="w"> </span>newuser@fancyplace.com<span class="w"> </span>--passfile2<span class="w"> </span>/fancyplace-pass.txt<span class="w"> </span>--ssl2<span class="w"> </span>--sslargs2<span class="w"> </span><span class="nv">SSL_verify_mode</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--automap<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--nofoldersizes<span class="w"> </span>--nofoldersizesatend<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--delete1<span class="w"> </span>--noexpungeaftereach<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--expunge1
</code></pre></div>

<p>Please test this with the <code>--dry</code> option if you ever want to do this - the <code>--automap</code> option worked incredibly well for me (even translating between languages for folders like "Sent Messages"), but check that for yourself.</p>
<p>What this script will do is start a Docker container and run imapsync within it, which will then check all folders on the old IMAP server and sync any found emails over to the new IMAP server <em>and then delete them from the old server</em>. This is unfortunately necessary because the old ISP in question has a pretty low storage limit and I don't want future email flow to stop because we forgot to go and delete old emails. imapsync appears to be pretty careful about making sure an email has synced correctly before it deletes it from the old server, so I'm not super worried about data loss.</p>
<p>The IMAP passwords are read from files that live in /root/ on my server (with <code>0400</code> permissions) and they are mounted through into the container. For the new IMAP account, this is a "per-device" password rather than the main account password, so it won't change, and is easy to revoke.</p>
<p>This isn't a complete setup yet though, because after doing one sync, imapsync will exit and Docker will obey its <code>--rm</code> option and delete the container. What we now need is a regular trigger to run this script and while this used to mean cron, nowadays it could also mean a <a href="https://www.freedesktop.org/software/systemd/man/systemd.timer.html">systemd timer</a>. So, I created a simple systemd service file which gets written to <code>/etc/systemd/system/imapsync-user-isp-fancyplace.service</code> and enabled in systemd:</p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">User IMAP Sync</span>
<span class="na">After</span><span class="o">=</span><span class="s">docker.service</span>
<span class="na">Requires</span><span class="o">=</span><span class="s">docker.service</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/imapsync-user-isp-fancyplace.sh</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">no</span>
<span class="na">TimeoutSec</span><span class="o">=</span><span class="s">120</span>
</code></pre></div>

<p>and a systemd timer file which gets written to <code>/etc/systemd/system/imapsync-user-isp-fancyplace.timer</code>, and then both enabled and started in systemd:</p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Trigger User IMAP Sync</span>

<span class="k">[Timer]</span>
<span class="na">Unit</span><span class="o">=</span><span class="s">imapsync-user-isp-fancyplace.service</span>
<span class="na">OnUnitActiveSec</span><span class="o">=</span><span class="s">10min</span>
<span class="na">OnUnitInactiveSec</span><span class="o">=</span><span class="s">10min</span>
<span class="na">Persistent</span><span class="o">=</span><span class="s">true</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">timers.target</span>
</code></pre></div>

<p>This will trigger every 10 minutes and start the specified service, which executes the script that starts the Dockule to sync the email. Simple!</p>
<p>And just to show a useful command, you can check when the timer last triggered, and when it will trigger next, like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># systemctl list-timers</span>
<span class="n">NEXT</span><span class="w">                         </span><span class="n">LEFT</span><span class="w">          </span><span class="n">LAST</span><span class="w">                         </span><span class="n">PASSED</span><span class="w">             </span><span class="n">UNIT</span><span class="w">                               </span><span class="n">ACTIVATES</span>
<span class="n">Mon</span><span class="w"> </span><span class="mi">2019</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">20</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">13</span><span class="w"> </span><span class="n">BST</span><span class="w">  </span><span class="mi">27</span><span class="n">s</span><span class="w"> </span><span class="n">left</span><span class="w">      </span><span class="n">Mon</span><span class="w"> </span><span class="mi">2019</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">20</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">13</span><span class="w"> </span><span class="n">BST</span><span class="w">  </span><span class="mi">9</span><span class="nb">min</span><span class="w"> </span><span class="n">ago</span><span class="w">           </span><span class="n">imapsync</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">isp</span><span class="o">-</span><span class="n">fancyplace</span><span class="o">.</span><span class="n">timer</span><span class="w"> </span><span class="n">imapsync</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">isp</span><span class="o">-</span><span class="n">fancyplace</span><span class="o">.</span><span class="n">service</span>
<span class="p">[</span><span class="n">snip</span><span class="w"> </span><span class="n">unrelated</span><span class="w"> </span><span class="n">timers</span><span class="p">]</span>

<span class="mi">9</span><span class="w"> </span><span class="n">timers</span><span class="w"> </span><span class="n">listed</span><span class="o">.</span>
<span class="n">Pass</span><span class="w"> </span><span class="o">--</span><span class="n">all</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">inactive</span><span class="w"> </span><span class="n">timers</span><span class="p">,</span><span class="w"> </span><span class="n">too</span><span class="o">.</span>
</code></pre></div>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2019/04/24/app-creation-failed.html">Failing to create an app</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Wed 24 April 2019</p>
    </p>
  </div>
  <div class="article__text">
    <p>I've just published <a href="https://github.com/cmsj/HotMic/">https://github.com/cmsj/HotMic/</a> which contains a very good amount of a macOS app I had hoped to complete and sell for a couple of bucks on the Mac App Store.</p>
<p>However, I failed to get it working, primarily because I don't know enough of CoreAudio to get it working, and because I burned almost all of the time I had to write the app, fighting with things that, it turns out, were never going to work.</p>
<p>So, chalk that one up to experience I guess. Maybe the next person who has this idea will find my repo and spend their allotted time getting it to work :)</p>
<p>For the curious, the app's purpose was to be a Play Through mechanism for OS X. What is a Play Through app? It means the app reads audio from one device (e.g. a microphone or a Line In port) and writes it out to a different device (e.g. your normal speakers). This lets you use your Mac as a very limited audio mixer. I want it so the Line Out from my PC can be connected to my iMac - then all of my computer audio comes out of one set of speakers with one keyboard volume control setup.</p>
<p>For the super curious, I'd be happy to get back to working on the app if someone who knows more about Core Audio than I do, wants to get involved!</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/07/12/gmail-as-dashboard.html">Abusing Gmail as a ghetto dashboard</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Thu 12 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>I'm sure many of us receive regular emails from the same source - by which I mean things like a daily status email from a backup system, or a weekly newsletter from a blogger/journalist we like, etc.</p>
<p>These are a great way of getting notified or kept up to date, but every one of these you receive is also a piece of work you need to do, to keep your Inbox under control. Gmail has a lot of powerful filtering primitives, but as far as I am able to tell, none of them let you manage this kind of email without compromise.</p>
<p>My ideal scenario would be that, for example, my daily backup status email would keep the most recent copy in my Inbox, and automatically archive older ones. Same for newsletters - if I didn't read last week's one, I'm realistically never going to, so once it's more than a couple of weeks stale, just get it out of my Inbox.</p>
<p>Thankfully, Google has an indirect way of making this sort of thing work - <a href="https://developers.google.com/apps-script/">Google Apps Script</a>. You can trigger small JavaScript scripts to run every so often, and operate on your data in various Google apps, including Gmail.</p>
<p>So, I quickly wrote <a href="https://gist.github.com/cmsj/0d12c452277f32704f347c7fe117215a">this script</a> and it runs every few hours now:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Configuration data</span>
<span class="c1">// Each config should have the following keys:</span>
<span class="c1">//  * age_min: maps to &#39;older_than:&#39; in gmail query terms</span>
<span class="c1">//  * age_max: maps to &#39;newer_than:&#39; in gmail query terms</span>
<span class="c1">//  * query: freeform gmail query terms to match against</span>
<span class="c1">//</span>
<span class="c1">// The age_min/age_max values don&#39;t need to exist, given the freeform query value,</span>
<span class="c1">// but age_min forces you to think about how frequent the emails are, and age_max</span>
<span class="c1">// forces you to not search for every single email tha matches the query</span>
<span class="c1">//</span>
<span class="c1">// TODO:</span>
<span class="c1">//  * Add a per-config flag that skips the archiving if there&#39;s only one matching thread (so the most recent matching email always stays in Inbox)</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;14d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;90d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">query</span><span class="o">:</span><span class="s2">&quot;subject:(Benedict&#39;s Newsletter)&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;7d&quot;</span><span class="p">,</span><span class="w">  </span><span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;30d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">query</span><span class="o">:</span><span class="s2">&quot;from:hello@visualping.io subject:gnubert&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span><span class="w">  </span><span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;7d&quot;</span><span class="p">,</span><span class="w">  </span><span class="nx">query</span><span class="o">:</span><span class="s2">&quot;subject:(Nightly clone to Thunderbay4 Successfully)&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span><span class="w">  </span><span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;7d&quot;</span><span class="p">,</span><span class="w">  </span><span class="nx">query</span><span class="o">:</span><span class="s2">&quot;from:Amazon subject:(Arriving today)&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">];</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">processInbox</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">config_key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">configs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">configs</span><span class="p">[</span><span class="nx">config_key</span><span class="p">];</span>
<span class="w">    </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Processing query: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">config</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]);</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">GmailApp</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;in:inbox &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">config</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; newer_than:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">config</span><span class="p">[</span><span class="s2">&quot;age_max&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; older_than:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">config</span><span class="p">[</span><span class="s2">&quot;age_min&quot;</span><span class="p">]);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">thread_key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">threads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">threads</span><span class="p">[</span><span class="nx">thread_key</span><span class="p">];</span>
<span class="w">      </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;  Archiving: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">thread</span><span class="p">.</span><span class="nx">getFirstMessageSubject</span><span class="p">());</span>

<span class="w">      </span><span class="nx">thread</span><span class="p">.</span><span class="nx">markRead</span><span class="p">();</span>
<span class="w">      </span><span class="nx">thread</span><span class="p">.</span><span class="nx">moveToArchive</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>(apologies for the very basic JavaScript - it's not a language I have any real desire to be good at. Don't @ me).</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/07/12/xcode-leaks-error.html">Fixing an error in Xcode Instruments's Leaks profile</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Thu 12 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>As part of our general effort to try and raise the quality of Hammerspoon, I've been working with <a href="https://twitter.com/latenitefilms">@latenitefilms</a> to track down some memory leaks, which can be very easy if you use the Leaks profile in Xcode's "Instruments" tool. I tried this various ways, but I kept running into this error:</p>
<p><img alt="Screenshot" src="http://cmsj.net/images/2018-07-12-xcode-leaks-error.png"></p>
<p>After asking on the <a href="https://forums.developer.apple.com/thread/104011">Apple Developer Forums</a> we got an interesting response from an Apple employee that code signing might be involved. One change later to not do codesigning on Profile builds and Leaks is working again!</p>
<p>So there we go, if you see "An error occurred trying to capture Leaks data" and "Unable to acquire required task port", one thing to check is your code signing setup. I don't know what specifically was wrong, but it's easy enough to just not sign local debug/profile builds most of the time anyway.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="http://cmsj.net/2018/07/05/amigaos41-in-qemu.html">AmigaOS 4.1 Final Edition in Qemu</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: Thu 05 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>So this is a fun one, some marvellous hackers, including Zoltan Balaton and Sebastien Mauer have been working on Qemu to add support for the <a href="https://en.wikipedia.org/wiki/Sam460ex">Sam460ex motherboard</a>, a PowerPC system from 2010. Of particular interest to me is that this was a board which received an official port of Amiga OS 4, the spiritual successor to AmigaOS, one of my very favourite operating systems.</p>
<p>I'll probably write more about this later, but for now, here is a simple screenshot of the install CD having just booted.</p>
<p><em>Update</em>: Zoltan has published a page with information about how to get it working, <a href="http://zero.eik.bme.hu/~balaton/qemu/amiga/">see here</a></p>
<p><img alt="Screenshot" src="http://cmsj.net/images/2018-07-05-amigaos-qemu.png"></p>
  </div>
</article>

<div class="pagination">
    <ul>
        <li class="pagination__prev">
            <div class="pagination__prev--none">&laquo;</div>
        </li>



          <li>
            <a class="pagination__page--current" href="http://cmsj.net/category/misc.html">1</a>
          </li>


          <li>
            <a  href="http://cmsj.net/category/misc2.html">2</a>
          </li>


          <li>
            <a  href="http://cmsj.net/category/misc3.html">3</a>
          </li>


          <li>
            <a  href="http://cmsj.net/category/misc4.html">4</a>
          </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


          <li>
            <a  href="http://cmsj.net/category/misc23.html">23</a>
          </li>

        <li class="pagination__next">
            <a href="http://cmsj.net/category/misc2.html">&raquo;</a>
        </li>
    </ul>
</div>

  </main>
    <footer>
      <div class="author__logo">
          <img src="http://cmsj.net/theme/images/logo.png" alt="logo">
      </div>
      <section class="author">
        <div class="author__name">
          <a href="http://cmsj.net/pages/about.html">Chris Jones</a>
          <p></p>
        </div>
        <div class="author__link">
          <ul>
            <li>
              <a href="https://twitter.com/cmsj" target="_blank" title="twitter">
                <i class="fab fa-twitter-square"></i>
              </a>
            </li>
            <li>
              <a href="https://github.com/cmsj" target="_blank" title="github">
                <i class="fab fa-github-square"></i>
              </a>
            </li>
            <li>
              <a href="http://cmsj.net/feeds/all.atom.xml" target="_blank" title="Feed">
                <i class="fas fa-rss-square"></i>
              </a>
            </li>
          </ul>
        </div>
      </section>
      <div class="ending-message">
        <p>&copy; Chris Jones. Powered by <a href="http://getpelican.com" target="_blank">Pelican</a>, Theme is using <a href="https://github.com/laughk/pelican-hss" target="_blank">HSS</a>. </p>
      </div>
    </footer>
</body>
</html>