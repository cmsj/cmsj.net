<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="../theme/css/style.less">
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="icon" type="image/vnd.microsoft.icon" href="../">
  <link rel="stylesheet" type="text/css" href="../theme/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/fontawesome-all.min.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/hatena-bookmark-icon.css">


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chris Jones">
  <meta name="description" content="Posts and writings by Chris Jones">

  <link href="http://cmsj.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cmsj.net Atom" />


  <title>
    cmsj.net
&ndash; Category: misc  </title>

</head>

<body>
  <main>
    <header>
      <div class="site-name">
        <a href="/">cmsj.net</a>
      </div>
      <p>
        <a href="../archives.html"><i class="fas fa-archive"></i> Archive</a>
&gt; Category: misc
      </p>
    </header>

<article>
  <div class="article__title">
    <h1><a href="../2019/05/20/app-creation-failed-update1.html">Update: Failing to create an app</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Mon 20 May 2019</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="/2019/04/24/app-creation-failed.html">Previously</a> I wrote about how I'd tried to create an app, but ultimately failed because I wasn't getting the results I wanted out of the macOS CoreAudio APIs.</p>
<p>Thanks to some excellent input from <a href="https://twitter.com/DavidLublin">David Lublin</a> I refactored the code to be able to switch easily between different backend audio APIs, and <a href="https://github.com/cmsj/HotMic/blob/master/HotMic/Audio%20Backends/THMBackEndAVFCapture.m">implemented a replacement</a> for CoreAudio using AVFoundation's AVCaptureSession and it seems to work!</p>
<p>I'd still like to settle back on CoreAudio at some point, but for now I can rest assured that whenever the older versions of SoundSource stop working, I still have a working option.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2019/05/20/imapsync-docker.html">Overengineered email migration</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Mon 20 May 2019</p>
    </p>
  </div>
  <div class="article__text">
    <p>I recently had the need to migrate someone in my family off an old ISP email account, onto a more modern email account, without simply shutting down the old account. The old address has been given out to people/companies for at least a decade, so it's simply not practical to stop receiving its email.</p>
<p>Initially, I used the ISP's own server-side filtering to forward emails on to the new account and then delete them, however, all of the fantabulous anti-spam technologies that are used these days, conspired to make it unreliable.</p>
<p>So instead, I decided that since I can access IMAP on both accounts, and I have a server at home running all the time, I'd just use some kind of local tool to fetch any emails that show up on the old account and move them to the new one.</p>
<p>After some investigation, I settled on <a href="https://imapsync.lamiral.info/">imapsync</a> as the most capable tool for the job. It's ultimately "just" a Perl script, but it's fantastically well maintained by Gilles Lamiral. It's Open Source, but I'm a big fan of supporting FOSS development, so I happily paid the 60â‚¬ Gilles asks for.</p>
<p>My strong preference these days is always to run my local services in Docker, and fortunately Gilles publishes an <a href="https://hub.docker.com/r/gilleslamiral/imapsync/">official imapsync Dockule</a> so I set to work in Ansible to orchestrate all of the pieces I needed to get this running.</p>
<p>The first piece was a simple bash script that calls imapsync with all of the necessary command line options:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># This is /usr/local/bin/imapsync-user-isp-fancyplace.sh</span>
/usr/bin/docker run -u root --rm -v/root/.imap-pass-isp.txt:/isp-pass.txt -v/root/.imap-pass-fancyplace.txt:/fancyplace-pass.txt gilleslamiral/imapsync <span class="se">\</span>
    imapsync <span class="se">\</span>
        --host1 imap.isp.net --port1 <span class="m">993</span> --user1 olduser@isp.net --passfile1 /isp-pass.txt --ssl1 --sslargs1 <span class="nv">SSL_verify_mode</span><span class="o">=</span><span class="m">1</span> <span class="se">\</span>
        --host2 imap.fancyplace.com --port2 <span class="m">993</span> --user2 newuser@fancyplace.com --passfile2 /fancyplace-pass.txt --ssl2 --sslargs2 <span class="nv">SSL_verify_mode</span><span class="o">=</span><span class="m">1</span> <span class="se">\</span>
        --automap <span class="se">\</span>
        --nofoldersizes --nofoldersizesatend <span class="se">\</span>
        --delete1 --noexpungeaftereach <span class="se">\</span>
        --expunge1
</pre></div>


<p>Please test this with the <code>--dry</code> option if you ever want to do this - the <code>--automap</code> option worked incredibly well for me (even translating between languages for folders like "Sent Messages"), but check that for yourself.</p>
<p>What this script will do is start a Docker container and run imapsync within it, which will then check all folders on the old IMAP server and sync any found emails over to the new IMAP server <em>and then delete them from the old server</em>. This is unfortunately necessary because the old ISP in question has a pretty low storage limit and I don't want future email flow to stop because we forgot to go and delete old emails. imapsync appears to be pretty careful about making sure an email has synced correctly before it deletes it from the old server, so I'm not super worried about data loss.</p>
<p>The IMAP passwords are read from files that live in /root/ on my server (with <code>0400</code> permissions) and they are mounted through into the container. For the new IMAP account, this is a "per-device" password rather than the main account password, so it won't change, and is easy to revoke.</p>
<p>This isn't a complete setup yet though, because after doing one sync, imapsync will exit and Docker will obey its <code>--rm</code> option and delete the container. What we now need is a regular trigger to run this script and while this used to mean cron, nowadays it could also mean a <a href="https://www.freedesktop.org/software/systemd/man/systemd.timer.html">systemd timer</a>. So, I created a simple systemd service file which gets written to <code>/etc/systemd/system/imapsync-user-isp-fancyplace.service</code> and enabled in systemd:</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">User IMAP Sync</span>
<span class="na">After</span><span class="o">=</span><span class="s">docker.service</span>
<span class="na">Requires</span><span class="o">=</span><span class="s">docker.service</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/imapsync-user-isp-fancyplace.sh</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">no</span>
<span class="na">TimeoutSec</span><span class="o">=</span><span class="s">120</span>
</pre></div>


<p>and a systemd timer file which gets written to <code>/etc/systemd/system/imapsync-user-isp-fancyplace.timer</code>, and then both enabled and started in systemd:</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Trigger User IMAP Sync</span>

<span class="k">[Timer]</span>
<span class="na">Unit</span><span class="o">=</span><span class="s">imapsync-user-isp-fancyplace.service</span>
<span class="na">OnUnitActiveSec</span><span class="o">=</span><span class="s">10min</span>
<span class="na">OnUnitInactiveSec</span><span class="o">=</span><span class="s">10min</span>
<span class="na">Persistent</span><span class="o">=</span><span class="s">true</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">timers.target</span>
</pre></div>


<p>This will trigger every 10 minutes and start the specified service, which executes the script that starts the Dockule to sync the email. Simple!</p>
<p>And just to show a useful command, you can check when the timer last triggered, and when it will trigger next, like this:</p>
<div class="highlight"><pre><span></span># systemctl list-timers
NEXT                         LEFT          LAST                         PASSED             UNIT                               ACTIVATES
Mon 2019-05-20 17:38:13 BST  27s left      Mon 2019-05-20 17:28:13 BST  9min ago           imapsync-user-isp-fancyplace.timer imapsync-user-isp-fancyplace.service
[snip unrelated timers]

9 timers listed.
Pass --all to see loaded but inactive timers, too.
</pre></div>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2019/04/24/app-creation-failed.html">Failing to create an app</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 24 April 2019</p>
    </p>
  </div>
  <div class="article__text">
    <p>I've just published <a href="https://github.com/cmsj/HotMic/">https://github.com/cmsj/HotMic/</a> which contains a very good amount of a macOS app I had hoped to complete and sell for a couple of bucks on the Mac App Store.</p>
<p>However, I failed to get it working, primarily because I don't know enough of CoreAudio to get it working, and because I burned almost all of the time I had to write the app, fighting with things that, it turns out, were never going to work.</p>
<p>So, chalk that one up to experience I guess. Maybe the next person who has this idea will find my repo and spend their allotted time getting it to work :)</p>
<p>For the curious, the app's purpose was to be a Play Through mechanism for OS X. What is a Play Through app? It means the app reads audio from one device (e.g. a microphone or a Line In port) and writes it out to a different device (e.g. your normal speakers). This lets you use your Mac as a very limited audio mixer. I want it so the Line Out from my PC can be connected to my iMac - then all of my computer audio comes out of one set of speakers with one keyboard volume control setup.</p>
<p>For the super curious, I'd be happy to get back to working on the app if someone who knows more about Core Audio than I do, wants to get involved!</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2018/07/12/gmail-as-dashboard.html">Abusing Gmail as a ghetto dashboard</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Thu 12 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>I'm sure many of us receive regular emails from the same source - by which I mean things like a daily status email from a backup system, or a weekly newsletter from a blogger/journalist we like, etc.</p>
<p>These are a great way of getting notified or kept up to date, but every one of these you receive is also a piece of work you need to do, to keep your Inbox under control. Gmail has a lot of powerful filtering primitives, but as far as I am able to tell, none of them let you manage this kind of email without compromise.</p>
<p>My ideal scenario would be that, for example, my daily backup status email would keep the most recent copy in my Inbox, and automatically archive older ones. Same for newsletters - if I didn't read last week's one, I'm realistically never going to, so once it's more than a couple of weeks stale, just get it out of my Inbox.</p>
<p>Thankfully, Google has an indirect way of making this sort of thing work - <a href="https://developers.google.com/apps-script/">Google Apps Script</a>. You can trigger small JavaScript scripts to run every so often, and operate on your data in various Google apps, including Gmail.</p>
<p>So, I quickly wrote <a href="https://gist.github.com/cmsj/0d12c452277f32704f347c7fe117215a">this script</a> and it runs every few hours now:</p>
<div class="highlight"><pre><span></span><span class="c1">// Configuration data</span>
<span class="c1">// Each config should have the following keys:</span>
<span class="c1">//  * age_min: maps to &#39;older_than:&#39; in gmail query terms</span>
<span class="c1">//  * age_max: maps to &#39;newer_than:&#39; in gmail query terms</span>
<span class="c1">//  * query: freeform gmail query terms to match against</span>
<span class="c1">//</span>
<span class="c1">// The age_min/age_max values don&#39;t need to exist, given the freeform query value,</span>
<span class="c1">// but age_min forces you to think about how frequent the emails are, and age_max</span>
<span class="c1">// forces you to not search for every single email tha matches the query</span>
<span class="c1">//</span>
<span class="c1">// TODO:</span>
<span class="c1">//  * Add a per-config flag that skips the archiving if there&#39;s only one matching thread (so the most recent matching email always stays in Inbox)</span>
<span class="kd">var</span> <span class="nx">configs</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;14d&quot;</span><span class="p">,</span> <span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;90d&quot;</span><span class="p">,</span> <span class="nx">query</span><span class="o">:</span><span class="s2">&quot;subject:(Benedict&#39;s Newsletter)&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;7d&quot;</span><span class="p">,</span>  <span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;30d&quot;</span><span class="p">,</span> <span class="nx">query</span><span class="o">:</span><span class="s2">&quot;from:hello@visualping.io subject:gnubert&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span>  <span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;7d&quot;</span><span class="p">,</span>  <span class="nx">query</span><span class="o">:</span><span class="s2">&quot;subject:(Nightly clone to Thunderbay4 Successfully)&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">age_min</span><span class="o">:</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span>  <span class="nx">age_max</span><span class="o">:</span><span class="s2">&quot;7d&quot;</span><span class="p">,</span>  <span class="nx">query</span><span class="o">:</span><span class="s2">&quot;from:Amazon subject:(Arriving today)&quot;</span> <span class="p">},</span>
  <span class="p">];</span>

<span class="kd">function</span> <span class="nx">processInbox</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">config_key</span> <span class="k">in</span> <span class="nx">configs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">configs</span><span class="p">[</span><span class="nx">config_key</span><span class="p">];</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Processing query: &quot;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]);</span>

    <span class="kd">var</span> <span class="nx">threads</span> <span class="o">=</span> <span class="nx">GmailApp</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;in:inbox &quot;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; newer_than:&quot;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">[</span><span class="s2">&quot;age_max&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; older_than:&quot;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">[</span><span class="s2">&quot;age_min&quot;</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">thread_key</span> <span class="k">in</span> <span class="nx">threads</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">thread</span> <span class="o">=</span> <span class="nx">threads</span><span class="p">[</span><span class="nx">thread_key</span><span class="p">];</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;  Archiving: &quot;</span> <span class="o">+</span> <span class="nx">thread</span><span class="p">.</span><span class="nx">getFirstMessageSubject</span><span class="p">());</span>

      <span class="nx">thread</span><span class="p">.</span><span class="nx">markRead</span><span class="p">();</span>
      <span class="nx">thread</span><span class="p">.</span><span class="nx">moveToArchive</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>(apologies for the very basic JavaScript - it's not a language I have any real desire to be good at. Don't @ me).</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2018/07/12/xcode-leaks-error.html">Fixing an error in Xcode Instruments's Leaks profile</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Thu 12 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>As part of our general effort to try and raise the quality of Hammerspoon, I've been working with <a href="https://twitter.com/latenitefilms">@latenitefilms</a> to track down some memory leaks, which can be very easy if you use the Leaks profile in Xcode's "Instruments" tool. I tried this various ways, but I kept running into this error:</p>
<p><img alt="Screenshot" src="../images/2018-07-12-xcode-leaks-error.png"></p>
<p>After asking on the <a href="https://forums.developer.apple.com/thread/104011">Apple Developer Forums</a> we got an interesting response from an Apple employee that code signing might be involved. One change later to not do codesigning on Profile builds and Leaks is working again!</p>
<p>So there we go, if you see "An error occurred trying to capture Leaks data" and "Unable to acquire required task port", one thing to check is your code signing setup. I don't know what specifically was wrong, but it's easy enough to just not sign local debug/profile builds most of the time anyway.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2018/07/05/amigaos41-in-qemu.html">AmigaOS 4.1 Final Edition in Qemu</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Thu 05 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>So this is a fun one, some marvellous hackers, including Zoltan Balaton and Sebastien Mauer have been working on Qemu to add support for the <a href="https://en.wikipedia.org/wiki/Sam460ex">Sam460ex motherboard</a>, a PowerPC system from 2010. Of particular interest to me is that this was a board which received an official port of Amiga OS 4, the spiritual successor to AmigaOS, one of my very favourite operating systems.</p>
<p>I'll probably write more about this later, but for now, here is a simple screenshot of the install CD having just booted.</p>
<p><em>Update</em>: Zoltan has published a page with information about how to get it working, <a href="http://zero.eik.bme.hu/~balaton/qemu/amiga/">see here</a></p>
<p><img alt="Screenshot" src="../images/2018-07-05-amigaos-qemu.png"></p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2018/07/04/home-pro-part1-update.html">Home networking like a pro - Part 1.1 - Network Storage Redux</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Wed 04 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>Back in <a href="/2017/06/22/home-pro-part-1-nas.html">this post</a> I described having switched from a Mac Mini + DAS setup, to a Synology and an Intel NUC setup, for my file storage and server needs.</p>
<p>For a time it was good, but I found myself wanting to run more server daemons, and the NUC wasn't really able to keep up. The Synology was plodding along fine, but I made the decision to unify them all into a more beefy Linux machine.</p>
<p>So, I bought an AMD Ryzen 5 1600 CPU and an A320M motherboard, 16GB of RAM and a micro ATX case with 8 drive bays, and set to work. That quickly proved to be a disaster because Linux wasn't stable on the AMD CPU - I hadn't even thought to check, because why wouldn't Linux be stable on an x86_64 CPU in 2018?! With that lesson learned, I swapped out the board/CPU for an Intel i7-8700 and a Z370 motherboard.</p>
<p>I didn't go with FreeNAS as my previous post suggested I might, because ultimately I wanted complete control, so it's a plain Ubuntu Server machine that is fully managed by Ansible playbooks. In retrospect it was a mistake to try and delegate server tasks to an appliance like the Synology, and it was a further mistake to try and deal with that by getting the NUC - I should have just cut my losses and gone straight to a Linux server. Lesson learned!</p>
<p>Instead of getting lost in the weeds of purchase choices and justifications, instead let's look at some of the things I'm doing to the server with Ansible.</p>
<p>First up is root disk encryption - it's nice to know that your data is private when at rest, but a headless machine in a cupboard is not a fun place to be typing a password on boot. Fortunately I have two ways round this - firstly, a KVM (a Lantronix Spider) and secondly, one can add dropbear to an initramfs so you can ssh into the initramfs to enter the password.</p>
<p>Here's the playbook tasks that put dropbear into the initramfs:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install dropbear-initramfs</span>
  <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dropbear-initramfs</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install busybox-static</span>
  <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">busybox-static</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="c1"># This is necessary because of https://bugs.launchpad.net/ubuntu/+source/busybox/+bug/1651818</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add initramfs hook to fix cryptroot-unlock</span>
  <span class="l l-Scalar l-Scalar-Plain">copy</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">dest</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/initramfs-tools/hooks/zz-busybox-initramfs-fix</span>
    <span class="l l-Scalar l-Scalar-Plain">src</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dropbear-initramfs/zz-busybox-initramfs-fix</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0744</span>
    <span class="l l-Scalar l-Scalar-Plain">owner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">update initramfs</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure dropbear-initramfs</span>
  <span class="l l-Scalar l-Scalar-Plain">lineinfile</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/dropbear-initramfs/config</span>
    <span class="l l-Scalar l-Scalar-Plain">regexp</span><span class="p p-Indicator">:</span> <span class="s">&#39;DROPBEAR_OPTIONS&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">line</span><span class="p p-Indicator">:</span> <span class="s">&#39;DROPBEAR_OPTIONS=&quot;-p</span><span class="nv"> </span><span class="s">31337</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">-j</span><span class="nv"> </span><span class="s">-k</span><span class="nv"> </span><span class="s">-I</span><span class="nv"> </span><span class="s">60&quot;&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">update initramfs</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add dropbear authorized_keys</span>
  <span class="l l-Scalar l-Scalar-Plain">copy</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">dest</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/dropbear-initramfs/authorized_keys</span>
    <span class="l l-Scalar l-Scalar-Plain">src</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dropbear-initramfs/dropbear-authorized_keys</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0600</span>
    <span class="l l-Scalar l-Scalar-Plain">owner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">update initramfs</span>

<span class="c1"># The format of the ip= kernel parameter is: &lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gw-ip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;</span>
<span class="c1"># It comes from https://git.kernel.org/pub/scm/libs/klibc/klibc.git/tree/usr/kinit/ipconfig/README.ipconfig?id=HEAD</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure boot IP and consoleblanking</span>
  <span class="l l-Scalar l-Scalar-Plain">lineinfile</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/default/grub</span>
    <span class="l l-Scalar l-Scalar-Plain">regexp</span><span class="p p-Indicator">:</span> <span class="s">&#39;GRUB_CMDLINE_LINUX_DEFAULT&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">line</span><span class="p p-Indicator">:</span> <span class="s">&#39;GRUB_CMDLINE_LINUX_DEFAULT=&quot;ip=10.0.88.11::10.0.88.1:255.255.255.0:gnubert:enp0s31f6:none</span><span class="nv"> </span><span class="s">loglevel=7</span><span class="nv"> </span><span class="s">consoleblank=0&quot;&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">update grub</span>
</pre></div>


<p>While this does rely on some external files, the important one is <code>zz-busybox-initramfs-fix</code> which works around <a href="https://bugs.launchpad.net/ubuntu/+source/busybox/+bug/1651818">a bug</a> in the busybox build that Ubuntu is currently using. Rather than paste the whole script here, you can see it <a href="https://gist.github.com/cmsj/515fbf602f983e796ea11f95ce32d537">here</a>.</p>
<p>The last task in the playbook configures Linux to boot with a particular networking config on a particular NIC, so you can ssh in. Once you're in, just run <code>cryptsetup-unlock</code> and your encrypted root is unlocked!</p>
<p>Another interesting thing I'm doing, is using <a href="https://github.com/borgbackup">Borg</a> for some backups. It's a pretty clever backup system, and it works over SSH, so I use the following Ansible task to allow a particular SSH key to log in to the server as root, in a way that forces it to use Borg:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy ssh borg access</span>
  <span class="l l-Scalar l-Scalar-Plain">authorized_key</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="l l-Scalar l-Scalar-Plain">key_options</span><span class="p p-Indicator">:</span> <span class="s">&#39;command=&quot;/usr/bin/borg</span><span class="nv"> </span><span class="s">serve</span><span class="nv"> </span><span class="s">--restrict-to-path</span><span class="nv"> </span><span class="s">/srv/tank/backups/borg&quot;,restrict&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="s">&quot;ssh-rsa</span><span class="nv"> </span><span class="s">BLAHBLAH</span><span class="nv"> </span><span class="s">cmsj@foo&quot;</span>
</pre></div>


<p>Now on client machines I can run <code>borg create --exclude-caches --compression=zlib -v -p -s ssh://gnuborg:22/srv/tank/backups/borg/foo/backups.borg::cmsj-{utcnow} $HOME</code> and because <code>gnuborg</code> is defined in <code>~/.ssh/config</code> it will use all the right ssh options (username, hostname and the SSH key created for this purpose):</p>
<div class="highlight"><pre><span></span>Host gnuborg
  User root
  Hostname gnubert.local
  IdentityFile ~/.ssh/id_rsa_herborg
</pre></div>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2018/07/02/homebridge-server-monitoring.html">Homebridge server monitoring</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Mon 02 July 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="https://github.com/nfarina/homebridge">Homebridge</a> is a great way to expose arbitrary devices to Apple's HomeKit platform. It has helped bridge the Google Nest and Netgear Arlo devices I have in my home, into my iOS devices, since neither of those manufacturers appear to be interested in becoming officially HomeKit compatible.</p>
<p>London has been having a little bit of a heatwave recently and it got me thinking about the Linux server I have running in a closet under the stairs - it has pretty poor airflow available to it, and I didn't know how hot its CPU was getting.</p>
<p>So, by the power of JavaScript, Homebridge and Linux's <code>/sys</code> filesystem, I was able to quickly whip up <a href="https://github.com/cmsj/homebridge-linux-temperature">a plugin</a> for Homebridge that will read an entry from Linux's temperature monitoring interface, and present it to HomeKit. In theory I could use it for sending notifications, but in practice I'm doing that via <a href="https://grafana.com/">Grafana</a> - the purpose of getting the information in HomeKit is so I can ask Siri what the server's temperature is.</p>
<p>The configuration is very simple, allowing you to configure one temperature sensor per instance of the plugin (but you could define multiple instances in your Homebridge <code>config.json</code>):</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;accessory&quot;</span><span class="p">:</span> <span class="s2">&quot;LinuxTemperature&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;gnubert&quot;</span><span class="p">,</span>
    <span class="nt">&quot;sensor_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/sys/bus/platform/devices/coretemp.0/hwmon/hwmon0/temp1_input&quot;</span><span class="p">,</span>
    <span class="nt">&quot;divisor&quot;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</pre></div>


<p>(<code>gnubert</code> is the hostname of my server).</p>
<p>Below is a screenshot showing the server's CPU temperature mingling with all of the Nest and Arlo items :)</p>
<p><img alt="Screenshot" src="../images/2018-07-02-server-temp-homekit.jpg"></p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2018/06/19/trello-mac-app-automation.html">A little bit of automation of the Trello Mac App</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Tue 19 June 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="https://www.trello.com">Trello</a> have a Mac app, which I use for work and it struck me this morning that several recurring calendar events I have, which exist to remind me to review a particular board, would be much more pleasant if they contained a link that would open the board directly.</p>
<p>That would be easy if I used the Trello website, but I quite like the app (even though it's really just a browser pretending to be an app), so I went spelunking.</p>
<p>To cut a long story short, the Trello Mac app registers itself as a handler for <code>trello://</code> URLs, so if you take any <code>trello.com</code> board URL and replace the <code>https://</code> part with <code>trello://</code> you can use it as a link in your calendar (or anywhere else) and it will open the board in the app.</p>
  </div>
</article>
<hr />
<article>
  <div class="article__title">
    <h1><a href="../2018/06/15/homebridge-in-docker.html">Homebridge in Docker, an adventure in networking</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Fri 15 June 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p><a href="https://github.com/nfarina/homebridge">Homebridge</a> is a great way of connecting <a href="https://www.npmjs.com/search?q=homebridge">loads</a> of devices that don't support Apple's <a href="https://www.apple.com/uk/ios/home/">HomeKit</a>, to your iOS devices. It consists of a daemon that understands the <a href="https://developer.apple.com/support/homekit-accessory-protocol/">HomeKit Accessory Protocol</a> and <a href="https://www.npmjs.com/search?q=homebridge">many plugins</a> that talk to other devices/services.</p>
<p>My home server is running Ubuntu, so installing Homebridge is fairly trivial, except I run all my services in <a href="https://www.docker.com">Docker</a> containers. To make things even more fun, I don't build or manage the containers by hand - the building is done by <a href="https://hub.docker.com/u/cmsj/">Docker Hub</a> and the containers are deployed and managed by <a href="https://www.ansible.com/">Ansible</a>.</p>
<p>So far so good, except that for a long time Homebridge used <a href="https://www.avahi.org/">Avahi</a> (an Open Source implementation of Apple's Bonjour host/service discovery protocol) to announce its devices. That presented a small challenge in that I didn't want to have Avahi running only in that container, so I had to bind mount <code>/var/run/avahi-daemon/</code> into the container.</p>
<p>I recently rebuilt my Homebridge container to pull it up to the latest versions of Homebridge and the plugins I use, but it was no longer announcing devices on my LAN, and there were no mentions of Avahi in its log. After some digging, it turns out that the HomeKit Accessory Protocol (HAP) library that Homebridge uses, now instantiates its own multicast DNS stack rather than using Avahi.</p>
<p>Apart from not actually working, this was great news, I could remove the <code>/var/run</code> bind mount from the container, making things more secure, I just needed to figure out why it wasn't showing up.</p>
<p>The HAP library that Homebridge uses, ends up depending on <a href="https://github.com/mafintosh/multicast-dns">this library</a> to implement mDNS and it makes <a href="https://github.com/mafintosh/multicast-dns/blob/master/index.js#L147">a very simple</a> decision about which network interface it should use. In my case, it was choosing the <code>docker0</code> bridge interface which explicitly isn't connected to the outside world. With no configuration options at the Homebridge level to influence the choice of interface, I had to solve the problem at the Docker network layer.</p>
<p>So, the answer was the following Ansible task to create a Docker network that is attached to my LAN interface (<code>bridge0</code>) and give it a small portion of a reserved segment in the IP subnet I use:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure LANbridge network</span>
  <span class="l l-Scalar l-Scalar-Plain">docker_network</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">lanbridge</span>
    <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">macvlan</span>
    <span class="l l-Scalar l-Scalar-Plain">driver_options</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">parent</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bridge0</span>
    <span class="l l-Scalar l-Scalar-Plain">ipam_options</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">subnet</span><span class="p p-Indicator">:</span> <span class="s">&#39;10.0.88.0/24&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">gateway</span><span class="p p-Indicator">:</span> <span class="s">&#39;10.0.88.1&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">iprange</span><span class="p p-Indicator">:</span> <span class="s">&#39;10.0.88.32/29&#39;</span>
</pre></div>


<p>then change the task for the Homebridge container to use this network:</p>
<div class="highlight"><pre><span></span>  network_mode: lanbridge
</pre></div>


<p>and now Homebridge is up to date, and working, plus I have a Docker network I can use in the future if any other containerised services need to be very close to the LAN.</p>
  </div>
</article>

<div class="pagination">
    <ul>
        <li class="pagination__prev">
            <div class="pagination__prev--none">&laquo;</div>
        </li>



          <li>
            <a class="pagination__page--current" href="../category/misc.html">1</a>
          </li>


          <li>
            <a  href="../category/misc2.html">2</a>
          </li>


          <li>
            <a  href="../category/misc3.html">3</a>
          </li>


          <li>
            <a  href="../category/misc4.html">4</a>
          </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


                <li>.....</li>
            </li>


          <li>
            <a  href="../category/misc23.html">23</a>
          </li>

        <li class="pagination__next">
            <a href="../category/misc2.html">&raquo;</a>
        </li>
    </ul>
</div>

  </main>
    <footer>
      <section class="author">
        <div class="author__link">
          <ul>
            <li>
              <a href="https://twitter.com/cmsj" target="_blank" title="twitter">
                <i class="fab fa-twitter-square"></i>
              </a>
            </li>
            <li>
              <a href="https://github.com/cmsj" target="_blank" title="github">
                <i class="fab fa-github-square"></i>
              </a>
            </li>
            <li>
              <a href="http://cmsj.net/feeds/all.atom.xml" target="_blank" title="Feed">
                <i class="fas fa-rss-square"></i>
              </a>
            </li>
          </ul>
        </div>
      </section>
      <div class="ending-message">
        <p>&copy; Chris Jones.</p>
      </div>
    </footer>
</body>
</html>